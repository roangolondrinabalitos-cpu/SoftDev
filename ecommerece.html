<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Project</title>
   <style>
    :root {
  --accent: #ff6f61;
  --accent-hover: #e55d50;
  --muted: #7b7b7b;
  --bg: #fff8f6;
  --card: #fff;
  --max-w: 1100px;
  --radius: 14px;
  --shadow: 0 4px 16px rgba(255,111,97,0.08);
    }
    * { box-sizing: border-box; }
    body {
      font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
      margin: 0;
      background: var(--bg);
      color: #222;
      line-height: 1.6;
    }
    header {
  background: linear-gradient(90deg,#fff 0,#ffe3db 100%);
  border-bottom: 1px solid #ffd1c7;
  box-shadow: 0 2px 8px rgba(255,111,97,0.06);
  position: sticky;
  top: 0;
  z-index: 60;
    }
    .container {
      max-width: var(--max-w);
      margin: 0 auto;
      padding: 1.2rem;
    }
    .topbar { display: none; }

    .shopee-header {
      width: 100%;
      background: linear-gradient(90deg,#fff 0,#ffe3db 100%);
      border-bottom: 1px solid #ffd1c7;
      box-shadow: 0 2px 8px rgba(255,111,97,0.06);
      z-index: 60;
      position: sticky;
      top: 0;
    }
    .shopee-header__top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.7rem 1.2rem 0.2rem 1.2rem;
      max-width: var(--max-w);
      margin: 0 auto;
    }
    .shopee-header__left {
      display: flex;
      align-items: center;
      gap: 0;
      flex: 1;
    }
    .shopee-header__logo {
      font-weight: 800;
      color: var(--accent);
      font-size: 1.5rem;
      letter-spacing: 1px;
      margin-right: 2.2rem;
      white-space: nowrap;
      display: flex;
      align-items: center;
    }
    .shopee-header__right {
      display: flex;
      align-items: center;
      gap: .7rem;
    }
    .header-nav-btn {
      background: none;
      color: var(--accent);
      border: none;
      border-radius: 12px;
      font-size: 1.08rem;
      font-weight: 500;
      padding: .6rem 1.5rem;
      text-transform: none;
      box-shadow: none;
      outline: none;
      transition: background 0.18s, color 0.18s;
    }
    .header-nav-btn:hover, .header-nav-btn:focus {
      background: #ffe3db;
      color: var(--accent-hover);
    }
    .shopee-header__bottom {
      width: 100%;
      background: none;
      display: flex;
      justify-content: center;
      padding-bottom: .7rem;
    }
    .shopee-header__search {
      width: 100%;
      max-width: 680px;
      margin: 0 1.2rem;
    }
    .search-with-btn { display:flex; gap:.6rem; align-items:center; }
    .search-with-btn input {
      width: 100%;
      padding: .7rem 1rem;
      border-radius: var(--radius);
      border: 1px solid #e2e8f0;
      font-size: 1rem;
      background: #fff3ee;
      transition: border 0.2s;
    }
    .search-with-btn button.search-btn {
      background: var(--accent);
      border: none;
      color: #fff;
      width: 44px;
      height: 44px;
      padding: 0;
      border-radius: 10px;
      cursor: pointer;
      display:flex;align-items:center;justify-content:center;
      box-shadow: 0 2px 8px rgba(15,23,42,0.06);
    }
    .svg-icon { width:20px;height:20px;display:inline-block;vertical-align:middle; }
    .cart-btn { position:relative; width:44px; height:44px; padding:0; display:flex; align-items:center; justify-content:center; border-radius:10px; background:transparent; }
    .cart-btn .cart-count { position:absolute; top:-6px; right:-6px; background:#ff3b30; color:#fff; font-size:.72rem; padding:.15rem .45rem; border-radius:999px; box-shadow:0 2px 6px rgba(0,0,0,0.08); }

    .shopee-header__top { padding: .5rem 1.2rem 0.6rem 1.2rem; }
    .shopee-header__logo { margin-right:1rem; font-size:1.45rem }
    .shopee-header__search { max-width:640px }
    .search-with-btn input:focus { border-color: var(--accent); outline: none; }

    .utility-bar { background: linear-gradient(90deg,#fff6f5 0,#ffe9e4 100%); font-size:.9rem; color:var(--muted); }
    .utility-bar .container { display:flex; justify-content:space-between; gap:1rem; padding:.45rem 1.2rem; }
    .utility-bar a { color:var(--accent); text-decoration:none; margin-left:.6rem; }
    .utility-bar .util-right { display:flex; gap:.6rem; align-items:center; }
    .icon-small { background:transparent;border:none;color:var(--muted);cursor:pointer;padding:.3rem .6rem;border-radius:8px }
    .icon-small:hover { color:var(--accent); }
    .notif-badge {
      position: absolute;
      top: -6px;
      right: -6px;
      background: #ff3b30;
      color: #fff;
      font-size: .68rem;
      padding: .12rem .45rem;
      border-radius: 999px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      line-height: 1;
      min-width: 18px; text-align:center;
    }
    .logo {
      font-weight: 800;
      color: var(--accent);
      font-size: 1.5rem;
      letter-spacing: 1px;
    }
    .tagline { font-size: .95rem; color: #d35a4a; margin-left:.6rem; font-weight:600 }
    .search {
      flex: 1;
      max-width: 520px;
      margin: 0 1rem;
    }
    .search input {
      width: 100%;
      padding: .7rem 1rem;
      border-radius: var(--radius);
      border: 1px solid #e2e8f0;
      font-size: 1rem;
  background: #fff3ee;
      transition: border 0.2s;
    }
    .search input:focus {
      border-color: var(--accent);
      outline: none;
    }
    .nav-actions {
      display: flex;
      gap: .7rem;
      align-items: center;
    }
    .header-preview { position:relative; }
    .preview-panel {
      position:absolute;
      right:0;
      top:calc(100% + 8px);
      min-width:260px;
      background:var(--card);
      border-radius:10px;
      box-shadow:0 8px 24px rgba(15,23,42,0.12);
      padding:.6rem;
      display:none;
      z-index:80;
    }
    /* show preview when JS toggles 'open' class */
    .preview-panel.open{ display:block; }
    .preview-item{ display:flex; gap:.6rem; align-items:center; padding:.4rem .2rem; border-radius:8px }
    .preview-item img{ width:44px;height:44px;object-fit:cover;border-radius:8px }
    .preview-empty{ color:var(--muted); padding:.6rem .4rem; }
    button {
      background: var(--accent);
      color: #fff;
      padding: .6rem 1.1rem;
      border: 0;
      border-radius: var(--radius);
      cursor: pointer;
      font-size: 1rem;
      font-weight: 500;
      box-shadow: 0 2px 8px rgba(15,23,42,0.04);
      transition: background 0.2s, box-shadow 0.2s;
    }
    button:hover {
      background: var(--accent-hover);
      box-shadow: 0 4px 16px rgba(15,23,42,0.09);
    }
    button.ghost {
      background: transparent;
      color: var(--accent);
      border: 1px solid var(--accent);
      box-shadow: none;
    }
    button.ghost:hover {
  background: #ffe3db;
  color: var(--accent-hover);
  border-color: var(--accent-hover);
    }
    main {
      max-width: var(--max-w);
      margin: 0 auto; /* center the main content */
      padding: 1.2rem; /* give breathing room */
    }
    .grid {
      display: grid;
      gap: 1.2rem;
    }
    /* homepage layout */
    .hero {
  display: flex;
  gap: 2rem;
  align-items: flex-start;
  justify-content: flex-start;
  margin-top: 30px;
  margin-bottom: 1.5rem;
    }
    .hero-left {
  flex: 1;
  display: flex;
  flex-direction: column;
  justify-content: center;
  gap: 1.5rem;
    }
    .hero-right {
    width: 500px;
    height: 1500px;
    min-width: 400px;
    margin-top: -50px;
    margin-left: 60px;
    padding: 1.2rem;
    display: flex;
    flex-direction: column;
    gap: 2.5rem;
    align-self: flex-start;
  
    }
    .featured {
  display: grid;
  grid-template-columns: repeat(auto-fill,minmax(160px,1fr));
  gap: 1rem;
  margin-top: 1rem;
    }
    /* categories */
    #categoriesRow .cat { display:flex;flex-direction:column;align-items:center;width:84px;padding:.6rem;border-radius:10px;cursor:pointer }
    #categoriesRow .cat img{ width:48px;height:48px;border-radius:12px;object-fit:cover }
    #flashDealsRow .deal { min-width:220px; max-width:220px; flex:0 0 220px }
    #flashDealsRow .deal .price { color:var(--accent); font-weight:800; }
    .card {
      background: var(--card);
      padding: 1.2rem;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      transition: box-shadow 0.2s, transform 0.2s;
    }
    /* Hover elevation only for product cards */
    .card.product-card:hover {
      box-shadow: 0 8px 32px rgba(15,23,42,0.13);
      transform: translateY(-2px) scale(1.01);
    }
    .product-card {
      display: flex;
      flex-direction: column;
      gap: .8rem;
      align-items: stretch;
    }
    /* Image frame inside product card - forces uniform image sizing */
    .product-card .img-frame {
      width: 100%;
      height: 160px;
      border-radius: 14px;
      background: #fff;
      padding: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 12px 30px rgba(15,23,42,0.06);
      margin: 0 auto;
      overflow: hidden;
    }
    .product-card .img-frame img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      border-radius: 8px;
    }
    .product-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .price {
      font-weight: 700;
      color: var(--accent);
      font-size: 1.1rem;
    }
    /* product card enhancements */
    .product-card { position:relative; overflow:hidden }
    .card.product-card { padding: 1.3rem; border-radius: 18px; box-shadow: 0 18px 40px rgba(15,23,42,0.08); }
    .product-card .card-body{ padding:.3rem 0 0 0; display:flex; flex-direction:column; gap:.4rem }
    .product-card .pname{ display:block; font-size:1.02rem; font-weight:700; color:#111; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:220px; margin-top:8px }
    .product-card .price{ font-weight:900; color:var(--accent); font-size:1.36rem; margin-top:8px; display:block; }
    .product-card .cat-tag{ position:absolute; top:14px; left:14px; display:inline-block; background:#fff0ef; border:1px solid #ffe3db; color:var(--accent); padding:.28rem .6rem; border-radius:999px; font-size:.78rem; font-weight:700; box-shadow: 0 4px 12px rgba(15,23,42,0.04); }
    .product-card .card-overlay{ position:absolute; inset:0; display:flex; align-items:flex-end; justify-content:center; gap:.6rem; padding:1rem; pointer-events:none; opacity:0; transition:opacity .12s }
    .product-card .small { color:var(--muted); }
    .product-card .sold-count { color:var(--muted); font-size:0.92rem; margin-top:6px; }
    .product-card:hover .card-overlay{ opacity:1; pointer-events:auto }
    .overlay-btn{ pointer-events:auto; background:rgba(255,255,255,0.95); border-radius:10px; padding:.5rem .7rem; border:1px solid #ffe6e0; cursor:pointer }
    .filters {
      display: flex;
      gap: .8rem;
      flex-wrap: wrap;
      margin-bottom: 1rem;
      align-items: center;
    }
    select, input[type=range], input, textarea {
      padding: .5rem .8rem;
      border-radius: var(--radius);
      border: 1px solid #e2e8f0;
      font-size: 1rem;
      background: #f3f6fa;
      transition: border 0.2s;
    }
    select:focus, input:focus, textarea:focus {
      border-color: var(--accent);
      outline: none;
    }
    .catalog {
      display: grid;
      grid-template-columns: repeat(auto-fill,minmax(240px,1fr));
      gap: 1.2rem;
    }
    /* modal */
    .modal {
  position: fixed;
  inset: 0;
  display: none;
  align-items: center;
  justify-content: center;
  background: rgba(8,10,19,0.18);
  z-index: 1000;
  backdrop-filter: blur(6px);
  transition: background 0.3s;
    }
    .modal.open {
  display: flex;
    }
    /* When the auth modal is open, show the site logo behind the panel */
    #authModalSection.modal.open {
        background:
          linear-gradient(rgba(8,10,19,0.32), rgba(8,10,19,0.32)),
          url('logo.png') center center / 60% auto no-repeat;
        background-attachment: scroll;
        backdrop-filter: blur(3px);
      }
      @media (max-width: 10000px) {
        /* on small screens make the logo smaller to avoid overlap with the panel */
        #authModalSection.modal.open { background-size: 100% auto; }
      }
    
    .modal .panel {
  width: 100%;
  max-width: 400px;
  background: var(--card);
  padding: 2.5rem 2rem 2rem 2rem;
  border-radius: 22px;
  box-shadow: 0 8px 32px rgba(15,23,42,0.18);
  display: flex;
  flex-direction: column;
  align-items: center;
    }
    .row {
      display: flex;
      gap: 2rem;
      flex-wrap: wrap;
    }
    .col {
      flex: 1;
      min-width: 220px;
    }
    /* cart */
    .cart-list {
      display: grid;
      gap: .8rem;
    }
    /* cart page layout improvements */
    .cart-controls { display:flex; gap:.5rem; align-items:center; }
    .qty-btn { width:28px;height:28px;border-radius:6px;border:1px solid #eee;background:#fff;cursor:pointer;display:inline-flex;align-items:center;justify-content:center }
    .qty-input { width:44px;text-align:center;padding:.35rem;border-radius:6px;border:1px solid #eee }
    .cart-summary { display:flex;flex-direction:column;gap:.6rem;min-width:240px }
    .cart-footer { display:flex;justify-content:space-between;align-items:center;margin-top:.6rem }
    .cart-item .actions{ display:flex;flex-direction:column;gap:.4rem;align-items:flex-end }
    .cart-item .meta { flex:1 }
    /* checkout layout */
    .checkout-grid { display:grid; grid-template-columns: 1fr 360px; gap:1rem; align-items:start }
    .checkout-summary { background:#fff8f6;border-radius:12px;padding:1rem;box-shadow:var(--shadow) }
    .checkout-summary .line { display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem }
    .checkout-shipping { margin-top:0.6rem }
    @media(max-width:900px){ .checkout-grid{ grid-template-columns: 1fr } .cart-summary { min-width: auto } }
    .cart-item {
      display: flex;
      gap: 1.2rem;
      align-items: center;
  background: #fff3ee;
      border-radius: var(--radius);
      padding: .7rem 1rem;
      box-shadow: 0 2px 8px rgba(15,23,42,0.04);
    }
    .cart-item img {
      width: 72px;
      height: 72px;
      object-fit: cover;
      border-radius: var(--radius);
  background: #fff8f6;
    }
    .small {
      font-size: .95rem;
      color: var(--muted);
    }
    footer {
      padding: 1.2rem;
      text-align: center;
      color: var(--muted);
      margin-top: 2.5rem;
  background: #fff3ee;
  border-top: 1px solid #ffd1c7;
      font-size: 1rem;
    }
    .admin-grid {
      display: grid;
      grid-template-columns: 1fr 380px;
      gap: 1.2rem;
    }
    /* Admin Orders improvements */
    .admin-tabs .ghost.active,
    .ghost.active {
      background: rgba(255,111,97,0.12);
      border-color: rgba(255,111,97,0.18);
      color: var(--accent);
    }
    .admin-orders-toolbar {
      display:flex;
      gap:0.6rem;
      align-items:center;
      margin-bottom:0.8rem;
      flex-wrap:wrap;
    }
    .admin-orders-toolbar input, .admin-orders-toolbar select {
      padding:.5rem .7rem;
      border-radius:10px;
      border:1px solid #e8e8e8;
      background:#fff;
    }
    .order-card {
      display:flex;
      gap:1rem;
      align-items:flex-start;
      padding:1rem;
      border-radius:12px;
      box-shadow: 0 6px 20px rgba(15,23,42,0.06);
      transition:transform .12s, box-shadow .12s;
    }
    .order-card:hover{ transform:translateY(-4px); box-shadow:0 10px 32px rgba(15,23,42,0.12); }
    .order-meta { flex:1; min-width:0 }
    .order-meta .muted { color:var(--muted); font-size:.95rem; }
    .order-actions { display:flex; flex-direction:column; gap:.5rem; align-items:flex-end }
    .status-badge { padding:.35rem .6rem; border-radius:999px; font-weight:700; font-size:.95rem; color:#fff; }
    .status-processing { background:#f6c84c; color:#2a1f00; }
    .status-shipped { background:#3aa0ff; }
    .status-delivered { background:#2ec16b; }
    .status-cancelled { background:#9aa0a6; }
  .status-icon { display:inline-block; width:16px; height:16px; margin-right:.45rem; vertical-align:middle; }
  /* utility hide that overrides other display rules */
  .hidden { display: none !important; }
    @media (max-width:800px) {
      .order-card { flex-direction:column; align-items:stretch }
      .order-actions { flex-direction:row; justify-content:space-between; align-items:center }
    }
    @media (max-width: 900px) {
      .hero {
        flex-direction: column;
        gap: 1.2rem;
      }
      .hero-right {
        width: 100%;
        min-width: unset;
        align-self: unset;
      }
      .featured {
        grid-template-columns: 1fr;
      }
      .admin-grid {
        grid-template-columns: 1fr;
      }
      main {
        padding: .7rem;
      }
      .container {
        padding: .7rem;
      }
    }
    @media (max-width: 600px) {
      .featured, .catalog {
        grid-template-columns: 1fr;
      }
      .row {
        flex-direction: column;
        gap: 1rem;
      }
      .modal .panel {
        padding: 1rem;
      }
    }
    /* Edit Profile: polished modern styles */
    #editProfileSection .ep-card {
      display: grid;
      grid-template-columns: 280px 1fr;
      gap: 1.4rem;
      align-items: start;
      padding: 1.4rem;
      border-radius: 16px;
      background: linear-gradient(180deg, #fff, #fffaf8);
      box-shadow: 0 18px 40px rgba(15,23,42,0.06);
      border: 1px solid rgba(250,230,225,0.8);
    }
    #editProfileSection .ep-sidebar {
      padding: 1rem;
      border-radius: 12px;
      background: linear-gradient(180deg,#fff 0,#fffaf6 100%);
      border: 1px solid rgba(255,232,226,0.9);
    }
    #editProfileSection .ep-sidebar .meta { display:flex; gap:1rem; align-items:center; margin-bottom:1rem }
    #editProfileSection .ep-sidebar .meta img { width:64px;height:64px;border-radius:50%;object-fit:cover;box-shadow:0 10px 30px rgba(15,23,42,0.08) }
    #editProfileSection .ep-nav { display:flex; flex-direction:column; gap:.6rem; margin-top:.6rem }
    #editProfileSection .ep-nav a { color:var(--muted); text-decoration:none; padding:.45rem .6rem; border-radius:10px; font-weight:600 }
    #editProfileSection .ep-nav a:hover { background:#fff3ee; color:var(--accent); box-shadow: inset 0 0 0 1px rgba(255,111,97,0.04); }
    #editProfileSection .ep-main { padding: .6rem 0 }
    #editProfileSection form.ep-form { display:grid; grid-template-columns: 1fr 320px; gap:1.2rem; align-items:start }
    #editProfileSection .ep-field { margin-bottom: .9rem }
    #editProfileSection label { display:block; font-weight:700; margin-bottom:.32rem; color:#333 }
    #editProfileSection input[type=text],
    #editProfileSection input[disabled],
    #editProfileSection select { width:100%; padding:.76rem .9rem; border-radius:12px; border:1px solid #f0e6e4; background:#fff; font-size:1rem; box-shadow: 0 6px 18px rgba(15,23,42,0.03) }
    #editProfileSection input[disabled] { background: #faf7f6; color: #777 }
    #editProfileSection input:focus, #editProfileSection select:focus { outline: none; border-color: var(--accent); box-shadow: 0 6px 18px rgba(255,111,97,0.06); }
    #editProfileSection .ep-avatar-wrap { text-align:center; }
    #editProfileSection .ep-avatar-box { position:relative; display:inline-block }
    #editProfileSection .ep-avatar { width:150px; height:150px; border-radius:50%; object-fit:cover; border:6px solid #fff; box-shadow:0 18px 40px rgba(15,23,42,0.12); display:block }
    #editProfileSection .ep-camera-overlay { position:absolute; right:-6px; bottom:-6px; background:var(--accent); color:#fff; width:44px; height:44px; border-radius:50%; display:flex; align-items:center; justify-content:center; border:3px solid #fff; box-shadow:0 8px 20px rgba(15,23,42,0.12); cursor:pointer }
    #editProfileSection .ep-avatar-hint { margin-top:.6rem; color:var(--muted); font-size:.95rem }
    #editProfileSection .ep-actions { display:flex; gap:.8rem; margin-top:.8rem }
    #editProfileSection .ep-actions button { padding:.8rem 1.2rem; border-radius:12px; font-weight:700 }
    #editProfileSection .ep-actions button.ghost { background:transparent;border:1px solid #eee;color:var(--muted) }
    #editProfileSection .ep-primary { background: linear-gradient(90deg,var(--accent),var(--accent-hover)); border: none; color: #fff }
    @media (max-width:900px) {
      #editProfileSection .ep-card { grid-template-columns: 1fr; }
      #editProfileSection form.ep-form { grid-template-columns: 1fr; }
      #editProfileSection .ep-avatar { width:120px;height:120px }
      #editProfileSection .ep-avatar-box .ep-camera-overlay { width:36px;height:36px; right: -4px; bottom:-4px }
    }
    /* Category slider styles */
    .cat-slider { position:relative; overflow:hidden; border-radius:14px; }
    .cat-slider .slides { display:flex; transition:transform 0.6s ease; will-change:transform; }
    .cat-slider .slide { min-width:100%; flex:0 0 100%; display:flex; align-items:center; gap:1rem; padding:1.2rem; box-sizing:border-box; }
    .cat-slider .slide .left { flex:1 }
    .cat-slider .slide .right { width:420px; height:160px; border-radius:12px; background-size:cover; background-position:center; display:flex; align-items:center; justify-content:center; color:var(--accent); font-weight:800; font-size:1.6rem }
    .cat-slider .controls { position:absolute; left:0; right:0; top:50%; transform:translateY(-50%); display:flex; justify-content:space-between; padding:0 10px; pointer-events:none }
    .cat-slider .controls button { pointer-events:all; background:rgba(255,255,255,0.9); border:1px solid rgba(0,0,0,0.06); padding:.5rem .7rem; border-radius:10px; box-shadow:0 6px 18px rgba(15,23,42,0.06); cursor:pointer }
    .cat-slider .dots { display:flex; gap:8px; justify-content:center; margin-top:.8rem }
    .cat-slider .dot { width:10px;height:10px;border-radius:999px;background:#eee;cursor:pointer }
    .cat-slider .dot.active { background:var(--accent) }
    @media (max-width:900px){ .cat-slider .right{ display:none } .cat-slider .slide{ padding:.8rem } }
  </style>
</head>
<body>
  <header>
    <div class="shopee-header">
      <div class="utility-bar">
        <div class="container">
          <div class="util-left">Follow us on <a id="followFB" href="#">Facebook </a><a id="followIG" href="#">| Instagram</a></div>
          <div class="util-right"><button id="notifMini" class="icon-small" title="Notifications">
              <svg class="svg-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M15 17H9a3 3 0 01-3-3V10a6 6 0 1112 0v4a3 3 0 01-3 3z" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/><path d="M13.73 21a2 2 0 01-3.46 0" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
              <span id="notifCount" class="notif-badge" style="display:none">0</span>
            </button><button id="helpBtn" class="icon-small">Help</button><select id="langSelect" style="border-radius:8px;padding:.25rem .5rem;border:1px solid #eee;background:#fff"><option value="en">English</option><option value="ph">Filipino</option></select></div>
        </div>
      </div>
      <div class="shopee-header__top">
        <div class="shopee-header__left">
          <div class="shopee-header__logo">BEAUXMART</div>
          <div class="shopee-header__search">
              <div class="search-with-btn">
                <input id="searchInput" placeholder="Search products"/>
                <button id="searchBtn" class="search-btn" title="Search">
                  <svg class="svg-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M21 21l-4.35-4.35" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><circle cx="11" cy="11" r="6" stroke="#fff" stroke-width="2"/></svg>
                </button>
              </div>
          </div>
        </div>
        <div class="shopee-header__right">
          <button id="btnHome" class="header-nav-btn">Home</button>
          <button id="btnCatalog" class="header-nav-btn">Product</button>
          <div class="header-preview">
            <button id="btnCart" class="header-nav-btn cart-btn" title="Cart">
              <svg class="svg-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M6 6h15l-1.5 9h-11L6 6z" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/><circle cx="10" cy="19" r="1" fill="currentColor"/><circle cx="18" cy="19" r="1" fill="currentColor"/></svg>
              <span id="cartCount" class="cart-count">0</span>
            </button>
          </div>
          <div class="header-preview">
            <button id="userMenuBtn" class="header-nav-btn"><img id="hdrAvatar" src="https://ui-avatars.com/api/?name=User" style="width:26px;height:26px;border-radius:50%;vertical-align:middle;margin-right:.4rem;"/> <span id="hdrEmailLabel" style="vertical-align:middle;">Account</span></button>
            <div class="preview-panel" id="userPreview"></div>
          </div>
          <button id="authBtn" class="header-nav-btn" style="display:none">Login</button>
        </div>
      </div>
    </div>
  </header>

    <main>
    <section id="authModalSection" class="modal">
      <div class="panel card" style="max-width:400px">
        <button id="closeAuthModal" style="position:absolute;top:18px;right:22px;background:transparent;color:#888;font-size:1.3rem;border:none;cursor:pointer">√ó</button>
        <div id="authModalContent" style="width:100%;display:flex;flex-direction:column;align-items:center;">
          <h2 id="authModalTitle" style="margin-bottom:1.2rem;font-size:2rem;font-weight:700;color:var(--accent)">Login</h2>
          <form id="authForm" style="width:100%;display:flex;flex-direction:column;gap:1rem;align-items:center;">
            <div style="width:100%">
              <label style="font-weight:500;margin-bottom:.3rem;display:block">Email</label>
              <input id="authEmail" type="email" required style="width:100%;padding:.8rem 1rem;margin-bottom:.3rem;border-radius:10px;border:1px solid #e2e8f0;font-size:1.1rem;background:#f3f6fa" />
            </div>
            <div style="width:100%">
              <label style="font-weight:500;margin-bottom:.3rem;display:block">Password</label>
              <input id="authPassword" type="password" required style="width:100%;padding:.8rem 1rem;margin-bottom:.3rem;border-radius:10px;border:1px solid #e2e8f0;font-size:1.1rem;background:#f3f6fa" />
            </div>
            <button type="submit" id="authSubmitBtn" style="width:100%;padding:.9rem 0;font-size:1.1rem;font-weight:600;background:var(--accent);color:#fff;border:none;border-radius:10px;box-shadow:0 2px 8px rgba(15,23,42,0.09);margin-top:.5rem;transition:background 0.2s">Login</button>
          </form>
          <div style="margin-top:1.2rem;text-align:center">
            <span id="toggleAuthMode" style="color:var(--accent);cursor:pointer;font-size:1.05rem;font-weight:500;text-decoration:underline">Don't have an account? Register</span>
          </div>
          <div id="authError" style="color:#e00;margin-top:.7rem;text-align:center;font-size:1.05rem"></div>
        </div>
  </div>
    </section>
    <section id="homeSection">
      <div class="container">
        <!-- Shopee-style Home Banner + Categories + Flash Deals + Featured -->
        <div class="home-banner" style="margin-top:8px;margin-bottom:12px;">
          <div class="cat-slider card" id="homeCatSlider" style="background:linear-gradient(90deg,#fff 0,#fff8f6 100%);">
            <div class="slides" id="homeCatSlides">
              <!-- slides will be generated dynamically from FIXED_CATEGORIES by initCategorySlider() -->
            </div>
            <div class="controls">
              <button id="catPrev" aria-label="Previous">‚Äπ</button>
              <button id="catNext" aria-label="Next">‚Ä∫</button>
            </div>
            <div class="dots" id="catDots" aria-hidden="false"></div>
          </div>
        </div>

        <div class="container" style="max-width:var(--max-w);padding:0;">
          <div class="card" style="padding:.8rem;margin-bottom:1rem;">
            <h3 style="margin:0 0 .6rem 0">Categories</h3>
            <div id="categoriesRow" style="display:flex;flex-wrap:wrap;gap:.8rem;
              align-items:center;
            "></div>
          </div>

          <div class="card" style="padding:.8rem;margin-bottom:1rem;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.6rem">
              <h3 style="margin:0">Flash Deals</h3>
              <div><button class="ghost" id="seeAllDeals">See All</button></div>
            </div>
            <div id="flashDealsRow" style="display:flex;gap:.8rem;overflow:auto;padding-bottom:.4rem;
              -webkit-overflow-scrolling:touch;
            "></div>
          </div>

          <div class="card" style="padding:.8rem;margin-bottom:1rem;">
            <h3 style="margin:0 0 .6rem 0">Top Products</h3>
            <div id="featuredList" class="featured"></div>
          </div>
        </div>
      </div>
    </section>

    <section id="catalogSection" style="display:none">
      <div class="container">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:.6rem;">
          <div style="display:flex;align-items:center;gap:.6rem">
            <button id="catalogBackBtn" class="ghost">‚Üê Back</button>
            <h2 style="margin:0">Product Catalog</h2>
          </div>
          <div id="catalogHeaderRight"></div>
        </div>
        <div class="filters" style="margin-bottom:1rem">
      <select id="catalogCategoryFilter"><option value="all">All categories</option></select>
      <label class="small">Max price: <span id="catalogPriceLabel">‚Ç±1000</span></label>
      <input id="catalogMaxPrice" type="number" min="0" max="200000" value="1000" />
      <select id="catalogSortSelect">
        <option value="newest">Newest</option>
        <option value="price-asc">Price: Low to High</option>
        <option value="price-desc">Price: High to Low</option>
        <option value="best-rated">Best Rated</option>
        <option value="popular">Most Popular</option>
      </select>
      <select id="catalogRatingFilter"><option value="0">Any rating</option><option value="4">4‚òÖ & up</option><option value="3">3‚òÖ & up</option></select>
    </div>
        <div id="catalogList" class="catalog"></div>
      </div>
    </section>

    <section id="productModalSection" class="modal">
      <div class="panel card">
        <button id="closeProductModal" style="float:right">Close</button>
        <div id="productDetails"></div>
      </div>
    </section>

    <section id="helpSection" style="display:none">
      <div class="container">
        <div class="card" style="padding:1.6rem;margin-bottom:1rem;background:linear-gradient(90deg,#fff 0,#ffeae6 100%);">
          <h1 style="margin:0;color:var(--accent);font-size:2rem;text-align:center">Hi, how can we help?</h1>
          <div style="max-width:820px;margin:1rem auto 0;display:flex;gap:.6rem;align-items:center">
            <input id="helpSearchInput" placeholder="Search..." style="flex:1;padding:.9rem 1rem;border-radius:8px;border:1px solid rgba(255,255,255,0.6);font-size:1.05rem;background:#fff" />
            <button id="helpSearchBtn" class="ghost" style="padding:.7rem 1rem;border-radius:8px;border:1px solid rgba(0,0,0,0.06);background:var(--accent);color:#fff">üîç</button>
          </div>
          <div id="helpSuggested" style="max-width:820px;margin:1rem auto 0;display:flex;gap:.6rem;flex-wrap:wrap"></div>
        </div>

        <div style="display:flex;gap:1rem;flex-wrap:wrap">
          <div style="flex:1;min-width:320px">
            <div class="card" style="padding:1rem;margin-bottom:1rem">
              <h3>Suggested Questions</h3>
              <div id="helpSuggestedList" style="margin-top:.6rem;display:flex;flex-direction:column;gap:.5rem"></div>
            </div>

            <div class="card" style="padding:1rem;">
              <h3>Frequently Asked Questions</h3>
              <div id="helpFaqs" style="margin-top:.6rem"></div>
            </div>
          </div>

          <div style="width:420px;min-width:300px">
            <div class="card" style="padding:1rem;">
              <h3>Contact Support</h3>
              <p class="small">If you need help, send us a message and we'll respond.</p>
              <form id="helpForm" style="display:flex;flex-direction:column;gap:.6rem;max-width:100%">
                <input id="helpName" placeholder="Your name" style="padding:.6rem;border-radius:8px;border:1px solid #e2e8f0" />
                <input id="helpEmail" placeholder="Your email" style="padding:.6rem;border-radius:8px;border:1px solid #e2e8f0" />
                <textarea id="helpMessage" rows="6" placeholder="Describe your issue" style="padding:.6rem;border-radius:8px;border:1px solid #e2e8f0"></textarea>
                <div style="display:flex;gap:.6rem;align-items:center">
                  <button id="sendHelpBtn" type="button" style="background:var(--accent);color:#fff;padding:.6rem 1rem;border-radius:8px;border:none">Send Message</button>
                  <button id="helpBackBtn" type="button" class="ghost">Back</button>
                </div>
                <div id="helpFeedback" class="small" style="color:var(--muted);margin-top:.4rem"></div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section id="cartSection" style="display:none">
      <div class="container">
        <h2>Your Cart</h2>
        <div class="card">
          <div id="cartList" class="cart-list"></div>
          <hr />
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <p class="small">Shipping option: <select id="shippingOption"><option value="standard">Standard - ‚Ç±100</option><option value="express">Express - ‚Ç±300</option></select></p>
            </div>
            <div>
              <strong>Total: ‚Ç±<span id="cartTotal">0</span></strong>
              <button id="checkoutBtn">Checkout</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section id="checkoutSection" style="display:none">
      <div class="container">
        <h2>Checkout</h2>
        <div class="card">
          <div class="row">
            <div class="col">
              <h4>Shipping & Payment</h4>
              <label>Full name</label><input id="shipName" placeholder="Juan Dela Cruz" style="width:100%;padding:.5rem;margin:.3rem 0;border-radius:6px;border:1px solid #e2e8f0" />
              <label>Address</label><input id="shipAddress" placeholder="Street, city, zip" style="width:100%;padding:.5rem;margin:.3rem 0;border-radius:6px;border:1px solid #e2e8f0" />
              <label>Payment method</label>
              <select id="paymentMethod" style="width:100%;padding:.5rem;margin:.3rem 0;border-radius:6px;border:1px solid #e2e8f0">
                <option value="card">Credit/Debit Card</option>
                <option value="ewallet">E‚ÄëWallet</option>
                <option value="cod">Cash on Delivery</option>
              </select>
              <div id="cardBox">
                <label>Card number</label><input id="cardNumber" placeholder="4242 4242 4242 4242" style="width:100%;padding:.5rem;margin:.3rem 0;border-radius:6px;border:1px solid #e2e8f0" />
              </div>
            </div>
            <div class="col">
              <h4>Order Summary</h4>
              <div id="checkoutSummary"></div>
              <hr />
              <button id="placeOrderBtn">Place Order</button>
            </div>
          </div>
        </div>
      </div>
    </section>


    <section id="accountSection" style="display:none">
      <div class="container">
        <h2>Your Account</h2>
        <div class="card">
          <div id="accountInfo"></div>
          <h3>My Orders</h3>
          <div style="margin-bottom:1rem;">
            <div id="orderTabs" style="display:flex;gap:1rem;margin-bottom:.7rem;">
              <button class="orderTabBtn" data-status="all">All</button>
              <button class="orderTabBtn" data-status="To Pay">To Pay</button>
              <button class="orderTabBtn" data-status="Processing">To Ship</button>
              <button class="orderTabBtn" data-status="Shipped">To Receive</button>
              <button class="orderTabBtn" data-status="Delivered">Completed</button>
              <button class="orderTabBtn" data-status="Cancelled">Cancelled</button>
            </div>
            <input id="orderSearchInput" placeholder="Search by Seller, Order ID, Product name" style="width:100%;padding:.6rem;border-radius:8px;border:1px solid #e2e8f0;margin-bottom:.7rem;" />
          </div>
          <div id="orderHistory"></div>
        </div>
      </div>
    </section>

    <section id="editProfileSection" style="display:none">
      <div class="container">
        <div class="card ep-card">
          <aside class="ep-sidebar">
            <div class="meta">
              <img src="https://ui-avatars.com/api/?name=User" id="epSidebarAvatar" alt="avatar" />
              <div>
                <div id="epSidebarName" style="font-weight:700">User</div>
                <div class="small" style="color:var(--muted)">Edit Profile</div>
              </div>
            </div>
            <nav class="ep-nav">
              <a href="#" onclick="show('account');return false;">My Account</a>
              <a href="#" onclick="show('account');return false;">Profile</a>
              <a href="#" onclick="show('account');return false;">Banks &amp; Cards</a>
              <a href="#" onclick="show('wishlist');return false;">My Wishlist</a>
            </nav>
          </aside>
          <div class="ep-main">
            <h3 style="margin-top:0">My Profile</h3>
            <div class="small" style="color:#888;margin-bottom:1rem">Manage and protect your account</div>
            <form id="editProfileFullForm" class="ep-form" onsubmit="return false;">
              <div>
                <div class="ep-field">
                  <label for="epUsername">Username</label>
                  <input id="epUsername" disabled />
                  <div class="small" style="color:#888;margin-top:.4rem">Username can only be changed once.</div>
                </div>
                <div class="ep-field">
                  <label for="epName">Name</label>
                  <input id="epName" />
                </div>
                <div class="ep-field">
                  <label for="epEmail">Email</label>
                  <div style="display:flex;gap:.6rem;align-items:center">
                    <input id="epEmail" disabled />
                    <a id="epChangeEmail" href="#" style="color:#1976d2;text-decoration:underline">Change</a>
                  </div>
                </div>
                <div class="ep-field">
                  <label for="epPhone">Phone Number</label>
                  <div style="display:flex;gap:.6rem;align-items:center">
                    <input id="epPhone" />
                    <a id="epChangePhone" href="#" style="color:#1976d2;text-decoration:underline">Add</a>
                  </div>
                </div>
                <div class="ep-field">
                  <label>Gender</label>
                  <div>
                    <input type="radio" name="epGender" id="epGenderMale" value="Male"><label for="epGenderMale"> Male</label>
                    <input type="radio" name="epGender" id="epGenderFemale" value="Female"><label for="epGenderFemale"> Female</label>
                    <input type="radio" name="epGender" id="epGenderOther" value="Other"><label for="epGenderOther"> Other</label>
                  </div>
                </div>
                <div class="ep-field">
                  <label>Date of birth</label>
                  <div style="display:flex;gap:.6rem;flex-wrap:wrap">
                    <select id="epDobDay"></select>
                    <select id="epDobMonth"></select>
                    <select id="epDobYear"></select>
                  </div>
                </div>
                <div class="ep-actions">
                  <button id="epSaveBtn" type="button">Save</button>
                  <button id="epCancelBtn" type="button" class="ghost">Cancel</button>
                </div>
              </div>

              <div class="ep-avatar-wrap">
                <div class="ep-avatar-box">
                  <img id="epAvatar" src="https://ui-avatars.com/api/?name=User" class="ep-avatar" alt="avatar" />
                  <button id="epSelectImage" class="ep-camera-overlay" type="button" title="Change photo">‚úö</button>
                </div>
                <input type="file" id="epAvatarInput" accept="image/*" style="display:none" />
                <div class="ep-avatar-hint">File size: maximum 1 MB ¬∑ .JPEG, .PNG</div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </section>

    <section id="wishlistSection" style="display:none">
      <div class="container">
        <h2>Your Wishlist</h2>
        <div id="wishlistList" class="catalog"></div>
      </div>
    </section>

    <section id="adminSection" style="display:none">
      <div class="container">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.2rem">
          <h2>Admin Dashboard</h2>
          <button id="adminPageLogoutBtn" style="background:#e00;color:#fff;padding:.6rem 1.2rem;border-radius:var(--radius);font-weight:600;font-size:1rem;">Logout</button>
        </div>
        <div style="display:flex;gap:1rem;margin-bottom:1.2rem">
          <button id="tabAdminProducts" class="ghost">Products</button>
          <button id="tabAdminAddProduct" class="ghost">Add Product</button>
          <button id="tabAdminOrders" class="ghost">Orders</button>
          <button id="tabAdminAnalytics" class="ghost">Analytics & Coupons</button>
        </div>
        <div id="adminTabProducts" style="display:block">
          <div class="card">
            <h3>Products</h3>
            <div id="adminProducts" class="catalog"></div>
          </div>
        </div>
        <div id="adminTabAddProduct" style="display:none">
          <div class="card">
            <h3>Add / Edit Product</h3>
            <input id="pId" placeholder="(auto or id)" style="width:100%;padding:.4rem;margin:.3rem 0;" />
            <input id="pName" placeholder="Name" style="width:100%;padding:.4rem;margin:.3rem 0;" />
            <input id="pCategory" placeholder="Category" style="width:100%;padding:.4rem;margin:.3rem 0;" />
            <input id="pPrice" placeholder="Price" type="number" style="width:100%;padding:.4rem;margin:.3rem 0;" />
            <input id="pStock" placeholder="Stock" type="number" style="width:100%;padding:.4rem;margin:.3rem 0;" />
            <input id="pImage" placeholder="Image URL" style="width:100%;padding:.4rem;margin:.3rem 0;" />
            <textarea id="pDesc" placeholder="Description" style="width:100%;padding:.4rem;margin:.3rem 0;" rows="3"></textarea>
            <button id="saveProductBtn">Save Product</button>
          </div>
        </div>
        <div id="adminTabOrders" style="display:none">
          <div class="card">
            <h3>Orders</h3>
            <div class="admin-orders-toolbar">
              <input id="adminOrderSearch" placeholder="Search orders by ID, email, or product" style="flex:1;min-width:220px" />
              <select id="adminOrderSort">
                <option value="newest">Newest</option>
                <option value="oldest">Oldest</option>
                <option value="total-desc">Total: High ‚Üí Low</option>
                <option value="total-asc">Total: Low ‚Üí High</option>
              </select>
              <button id="adminRefreshOrders" class="ghost">Refresh</button>
            </div>
            <div id="adminOrders"></div>
          </div>
        </div>
        <div id="adminTabAnalytics" style="display:none">
          <div class="card">
            <h3>Analytics</h3>
            <div id="salesReport"></div>
          </div>
          <div class="card" style="margin-top:1rem">
            <h3>Vouchers</h3>
            <input id="couponCode" placeholder="CODE10" style="width:100%;padding:.4rem;margin:.3rem 0;" />
            <input id="couponDisc" placeholder="10 (percent)" type="number" style="width:100%;padding:.4rem;margin:.3rem 0;" />
            <button id="addCouponBtn">Add Voucher</button>
            <div id="couponList"></div>
          </div>
          <div class="card" style="margin-top:1rem">
            <h3>Support Messages</h3>
            <div id="helpMessagesAdmin"></div>
          </div>
        </div>
      </div>
    </section>

  </main>

  <footer>
    <div class="container small"><p>&copy; <span id="year"></span> Software Development Finals.</p></div>
  </footer>

  <script type="module">
    const API_BASE = window.AUTH_API_BASE || 'http://127.0.0.1:4000';

    async function apiFetch(path, opts = {}) {
      const token = localStorage.getItem('ms_token');
      const headers = Object.assign({'Content-Type':'application/json'}, opts.headers || {});
      if (token) headers['Authorization'] = 'Bearer ' + token;
      const url = API_BASE + path;
      console.log('API Fetch:', opts.method || 'GET', url);
      try {
        const res = await fetch(url, Object.assign({}, opts, { headers }));
        const text = await res.text();
        let data = null;
        try { data = text ? JSON.parse(text) : null; } catch(e) { data = { message: text }; }
        return { ok: res.ok, status: res.status, data };
      } catch(err) {
        console.error('API Fetch error:', err);
        return { ok: false, status: 0, data: { message: err.message || 'Network error' } };
      }
    }
    const apiPost = (path, body) => apiFetch(path, { method: 'POST', body: JSON.stringify(body) });
    const apiGet = (path) => apiFetch(path, { method: 'GET' });

    function setUserAndToken(user, token){
      if(token) localStorage.setItem('ms_token', token);
      if(user) localStorage.setItem('ms_user', JSON.stringify(user)); else localStorage.removeItem('ms_user');
    }

    async function doLogin(email, password){
      console.log('doLogin:', email, '-> calling', API_BASE + '/auth/login');
      return await apiPost('/auth/login', { email, password });
    }
    async function doRegister(email, password){
      console.log('doRegister:', email, '-> calling', API_BASE + '/auth/register');
      return await apiPost('/auth/register', { email, password });
    }

    async function fetchMe(){
      try{
        const res = await apiGet('/auth/me');
        if(res && res.ok && res.data && res.data.user){ localStorage.setItem('ms_user', JSON.stringify(res.data.user)); return res.data.user; }
      }catch(e){
        console.warn('fetchMe failed', e);
      }
      localStorage.removeItem('ms_token');
      localStorage.removeItem('ms_user');
      return null;
    }

    async function doLogout(){
      localStorage.removeItem('ms_token');
      localStorage.removeItem('ms_user');
      try{ refreshUI(); enforceAuthUI(); }catch(e){}
    }
    window.doLogin = doLogin;
    window.doRegister = doRegister;
    window.doLogout = doLogout;
    window.fetchMe = fetchMe;
    window.AUTH_API_BASE = API_BASE;

function populateCategoryFilter() {
  const select = document.getElementById('categoryFilter');
  if(!select) return;
  select.innerHTML = '<option value="all">All categories</option>' + FIXED_CATEGORIES.map(cat => `<option value="${cat}">${cat}</option>`).join('');
}
    // ------------------------
    const LS_PRODUCTS = 'ms_products_v1';
    const LS_ORDERS = 'ms_orders_v1';
    const LS_COUPONS = 'ms_coupons_v1';

    function getProducts(){ return JSON.parse(localStorage.getItem(LS_PRODUCTS) || '[]'); }
    function saveProducts(arr){ localStorage.setItem(LS_PRODUCTS, JSON.stringify(arr)); }
    function getOrders(){ return JSON.parse(localStorage.getItem(LS_ORDERS) || '[]'); }
    function saveOrders(arr){ localStorage.setItem(LS_ORDERS, JSON.stringify(arr)); }
   
    function getSoldCount(productId){
      const orders = getOrders() || [];
      let total = 0;
      orders.forEach(o=>{
        (o.items||[]).forEach(it=>{ if(it && it.id === productId) total += parseInt(it.qty || 0, 10); });
      });
      return total;
    }
    function formatSoldCount(n){
      n = Number(n) || 0;
      if(n >= 1000000) return Math.floor(n/1000000) + 'M+ sold';
      if(n >= 1000) return Math.floor(n/1000) + 'K+ sold';
      if(n === 0) return '0 sold';
      return n + ' sold';
    }
    function getCoupons(){ return JSON.parse(localStorage.getItem(LS_COUPONS) || '[]'); }
    function saveCoupons(arr){ localStorage.setItem(LS_COUPONS, JSON.stringify(arr)); }

    function cartKey(uid){ return `ms_cart_${uid}`; }
    function wishlistKey(uid){ return `ms_wish_${uid}`; }

    function seedIfEmpty(){
      if(getProducts().length === 0){
        const sample = [
          {id: 'p1', name:'Wedge Sandals', category:'Shoes', price:79.99, stock:25, img:'img/Wedge Sandals.png', desc:'Comfortable everyday wear.', rating:4.5, reviews:[]},
          {id: 'p2', name:'Zipup Jumper', category:'Clothing', price:899, stock:40, img:'img/Zipup Jumper.png', desc:'Soft cotton hoodie.', rating:4.2, reviews:[]},
          {id: 'p3', name:'Acer Nitro', category:'Electronics, Gadgets', price:129.99, stock:10, img:'img/Acer Nitro.png', desc:'Noise-cancelling sound.', rating:4.7, reviews:[]},
        ];
        saveProducts(sample);
      }
      if(getCoupons().length===0){ saveCoupons([{code:'WELCOME10',percent:10}]); }
    }

    const FIXED_CATEGORIES = [
      'Electronics, Gadgets',
      'Clothing',
      'Health & Beauty',
      'Home & Living',
      'Shoes',
      'Accessories',
      'Kids & Babies',
      'Toys & Hobbies',
      'Books & Stationery',
      'Bags & Wallets'
    ];

    const CATEGORY_BANNER_TEXT = {
      'Electronics, Gadgets': { title: 'Electronics, Gadgets', subtitle: 'Top picks: laptops, accessories and more' },
      'Clothing': { title: 'New Season Clothing', subtitle: 'Refresh your wardrobe with best sellers' },
      'Health & Beauty': { title: 'Health & Beauty', subtitle: 'Skincare, wellness and grooming' },
      'Home & Living': { title: 'Home & Living', subtitle: 'Essentials and decor for your home' },
      'Shoes': { title: 'Shoes & Footwear', subtitle: 'Comfortable and stylish footwear' },
      'Accessories': { title: 'Accessories', subtitle: 'Bags, jewelry and everyday extras' },
      'Kids & Babies': { title: 'Kids & Babies', subtitle: 'Cute and safe picks for little ones' },
      'Toys & Hobbies': { title: 'Toys & Hobbies', subtitle: 'Fun toys and creative kits' },
      'Books & Stationery': { title: 'Books & Stationery', subtitle: 'Reads, planners and stationery' },
      'Bags & Wallets': { title: 'Bags & Wallets', subtitle: 'Carry everything in style' }
    };

    seedIfEmpty();

    const sections = {
      home: document.getElementById('homeSection'),
      catalog: document.getElementById('catalogSection'),
      cart: document.getElementById('cartSection'),
      checkout: document.getElementById('checkoutSection'),
      account: document.getElementById('accountSection'),
      editProfile: document.getElementById('editProfileSection'),
      wishlist: document.getElementById('wishlistSection'),
      admin: document.getElementById('adminSection'),
      help: document.getElementById('helpSection')
    };

    const authBtn = document.getElementById('authBtn');
    const accountBox = document.getElementById('accountBox');
    const cartCountEl = document.getElementById('cartCount');
    const wishCountEl = document.getElementById('wishCount');

    // navigation
    document.getElementById('btnHome').addEventListener('click',()=>show('home'));
    document.getElementById('btnCatalog').addEventListener('click',()=>show('catalog'));
    // helper to toggle preview panels (mobile / click-friendly)
    function togglePreview(id){
      document.querySelectorAll('.preview-panel.open').forEach(p=>{ if(p.id!==id) p.classList.remove('open'); });
      const panel = document.getElementById(id); if(!panel) return; panel.classList.toggle('open');
    }
    const btnCart = document.getElementById('btnCart');
    const btnWish = document.getElementById('btnWishlist');
    const btnNotif = document.getElementById('notifBtn');
    const btnUser = document.getElementById('userMenuBtn');
    if(btnCart) {
     
      btnCart.addEventListener('click', (e) => { e.stopPropagation(); show('cart'); renderCart(); });
    }
    if(btnWish) btnWish.addEventListener('click',(e)=>{ e.stopPropagation(); togglePreview('wishPreview'); });
    if(btnNotif) btnNotif.addEventListener('click',(e)=>{ e.stopPropagation(); togglePreview('notifPreview'); });
    if(btnUser) btnUser.addEventListener('click',(e)=>{ e.stopPropagation(); togglePreview('userPreview'); });
   

    document.getElementById('searchInput').addEventListener('input',(e)=>{
      const q = e.target.value.toLowerCase(); renderCatalog(q);
    });

    function hideAll(){ Object.values(sections).forEach(s=>s.style.display='none'); }
    function show(which){
      hideAll();
      if(which==='home') sections.home.style.display='block';
      else if(which==='catalog') sections.catalog.style.display='block';
      else if(which==='cart') sections.cart.style.display='block';
      else if(which==='checkout') sections.checkout.style.display='block';
      else if(which==='account') sections.account.style.display='block';
      else if(which==='editProfile') sections.editProfile.style.display='block';
      else if(which==='wishlist') sections.wishlist.style.display='block';
      else if(which==='admin') sections.admin.style.display='block';
      else if(which==='help') sections.help.style.display='block';
      window.scrollTo(0,0);
      refreshUI();
      try {
        const _btnHome = document.getElementById('btnHome');
        if(_btnHome) {
          if (which === 'home') _btnHome.classList.add('hidden'); else _btnHome.classList.remove('hidden');
        }
      } catch(e) { }
    }

   
    const authModal = document.getElementById('authModalSection');
    const authForm = document.getElementById('authForm');
    const authEmail = document.getElementById('authEmail');
    const authPassword = document.getElementById('authPassword');
    const authModalTitle = document.getElementById('authModalTitle');
    const authSubmitBtn = document.getElementById('authSubmitBtn');
    const toggleAuthMode = document.getElementById('toggleAuthMode');
    const authError = document.getElementById('authError');
    let isLoginMode = true;

    function openAuthModal(loginMode=true){
      isLoginMode = loginMode;
      authModal.classList.add('open');
      authModalTitle.textContent = loginMode ? 'Login' : 'Register';
      authSubmitBtn.textContent = loginMode ? 'Login' : 'Register';
      toggleAuthMode.textContent = loginMode ? "Don't have an account? Register" : "Already have an account? Login";
      authError.textContent = '';
      authEmail.value = '';
      authPassword.value = '';
    }

    authBtn.addEventListener('click', async ()=>{
      const user = currentUser();
      if(user){
        if(confirm('Sign out?')){
          await doLogout();
        }
      } else {
        openAuthModal(true);
      }
    });

    document.getElementById('closeAuthModal').addEventListener('click',()=>{
      authModal.classList.remove('open');
    });

    toggleAuthMode.addEventListener('click',()=>{
      openAuthModal(!isLoginMode);
    });

    authForm.addEventListener('submit', async function(e){
      e.preventDefault();
      const email = authEmail.value.trim();
      const pass = authPassword.value;
      if(!email || !pass) { authError.textContent = 'Please enter email and password.'; return; }
      try {
        if(isLoginMode){
          const res = await doLogin(email, pass);
          if(res && res.ok){
            setUserAndToken(res.data.user, res.data.token);
            authModal.classList.remove('open');
            alert('Logged in');
          } else {
            authError.textContent = (res && res.data && res.data.message) || 'Login failed';
          }
        } else {
          const res = await doRegister(email, pass);
          if(res && res.ok){
            setUserAndToken(res.data.user, res.data.token);
            authModal.classList.remove('open');
            alert('Registered and logged in');
          } else {
            authError.textContent = (res && res.data && res.data.message) || 'Registration failed';
          }
        }
      } catch(e){
        authError.textContent = e && e.message ? e.message : 'Authentication failed';
      }
    });
    

    function currentUser(){ return JSON.parse(localStorage.getItem('ms_user')||'null'); }


    function openProduct(id) {
      const p = getProducts().find(x => x.id === id);
      if (!p) return;
      const details = document.getElementById('productDetails');
      details.innerHTML = `
        <div style="display:flex;flex-direction:column;align-items:center;">
          <img src="${p.img}" style="width:90%;max-width:320px;height:180px;object-fit:cover;border-radius:12px;margin-bottom:1rem;box-shadow:0 2px 8px #eee;" />
          <h2 style="margin-bottom:.5rem;">${p.name}</h2>
          <div class="small" style="margin-bottom:.3rem;">${p.category} ‚Ä¢ ‚Ç±${p.price.toFixed(2)}</div>
          <div class="small" style="margin-bottom:.3rem;">${renderStars(p.rating)} (${p.rating}) ‚Ä¢ ${formatSoldCount(getSoldCount(p.id))}</div>
          <p style="margin:1rem 0;text-align:center;">${p.desc}</p>
          <div style="margin-bottom:1rem;width:100%;">${renderReviews(p.reviews)}</div>
          <div style="display:flex;gap:1rem;justify-content:center;margin-bottom:1rem;">
            <button id="modalAddToCartBtn">Add to Cart</button>
            <button id="modalBuyNowBtn" style="background:var(--accent);color:#fff;">Buy Now</button>
            <button id="modalWishBtn" class="ghost" style="font-size:1.3rem;">${getWishlist().includes(p.id) ? '‚ô•' : '‚ô°'}</button>
          </div>
          <form id="reviewForm" style="width:100%;max-width:320px;margin-top:1rem;display:flex;flex-direction:column;gap:.5rem;">
            <h4 style="margin-bottom:.2rem;">Leave a Review</h4>
            <input id="reviewerName" placeholder="Your name" required style="padding:.5rem;border-radius:8px;border:1px solid #e2e8f0;" />
            <select id="reviewerRating" required style="padding:.5rem;border-radius:8px;border:1px solid #e2e8f0;">
              <option value="5">5 - Excellent</option>
              <option value="4">4 - Good</option>
              <option value="3">3 - Average</option>
              <option value="2">2 - Poor</option>
              <option value="1">1 - Terrible</option>
            </select>
            <textarea id="reviewerText" placeholder="Your review" required style="padding:.5rem;border-radius:8px;border:1px solid #e2e8f0;"></textarea>
            <button type="submit">Submit Review</button>
          </form>
        </div>
      `;
      document.getElementById('productModalSection').classList.add('open');
  
      document.getElementById('modalAddToCartBtn').onclick = function() {
        addToCart(p.id);
      };
     
      document.getElementById('modalBuyNowBtn').onclick = function() {
        addToCart(p.id);
        show('checkout');
        renderCheckout();
        document.getElementById('productModalSection').classList.remove('open');
      };
    
      document.getElementById('modalWishBtn').onclick = function() {
        toggleWish(p.id);
        openProduct(p.id);
      };
      
      document.getElementById('reviewForm').onsubmit = function(e) {
        e.preventDefault();
        const name = document.getElementById('reviewerName').value.trim();
        const rating = parseInt(document.getElementById('reviewerRating').value);
        const text = document.getElementById('reviewerText').value.trim();
        if (!name || !text || !rating) return;
        const products = getProducts();
        const prod = products.find(x => x.id === id);
        if (!prod) return;
        prod.reviews = prod.reviews || [];
        prod.reviews.push({ name, rating, text, date: new Date().toISOString() });
        prod.rating = calcAvgRating(prod.reviews);
        saveProducts(products);
        openProduct(id);
      };
    }
   
    function renderFeatured(){
      const list = document.getElementById('featuredList'); list.innerHTML='';
      const products = getProducts().slice(0,12);
      products.forEach(p=>{
        const el = document.createElement('div'); el.className='card product-card';
        el.innerHTML = `
          <div class="img-frame"><img src="${p.img}" alt="${p.name}"/></div>
          <div class="card-body">
            <span class="cat-tag">${p.category}</span>
            <strong class="pname">${p.name}</strong>
            <div class="price">‚Ç±${p.price.toFixed(2)}</div>
            <div class="sold-count">${formatSoldCount(getSoldCount(p.id))}</div>
          </div>
          <div class="card-overlay">
            <button class="overlay-btn" data-add="${p.id}">Add</button>
          </div>
        `;

            el.style.cursor = 'pointer';
            el.addEventListener('click', ()=> openProduct(p.id));
            el.querySelectorAll('[data-add]').forEach(b=> b.addEventListener('click', (e)=>{ addToCart(b.getAttribute('data-add')); e.stopPropagation(); }));
        list.appendChild(el);
      });
    }

   
function getCatalogFilterValues() {
  const catalogSection = document.getElementById('catalogSection');
  const getVal = (id) => { const el = document.getElementById(id); return el ? el.value : null; };
  if (catalogSection && catalogSection.style.display !== 'none') {
    const category = getVal('catalogCategoryFilter') || 'all';
    let maxPrice = parseFloat(getVal('catalogMaxPrice') || getVal('catalogPriceRange') || getVal('priceRange'));
    if (isNaN(maxPrice)) maxPrice = 0;
    const sort = getVal('catalogSortSelect') || 'newest';
    let minRating = parseFloat(getVal('catalogRatingFilter'));
    if (isNaN(minRating)) minRating = 0;
    return { category, maxPrice, sort, minRating };
  } else {
    const category = getVal('categoryFilter') || 'all';
    let maxPrice = parseFloat(getVal('priceRange'));
    if (isNaN(maxPrice)) maxPrice = 0;
    const sort = getVal('sortSelect') || 'newest';
    let minRating = parseFloat(getVal('ratingFilter'));
    if (isNaN(minRating)) minRating = 0;
    return { category, maxPrice, sort, minRating };
  }

    function renderEditProfile(){
      const sect = document.getElementById('editProfileSection'); if(!sect) return;
      const user = currentUser();
      if(!user){ alert('Please login to edit profile'); show('home'); return; }
     
      const sbName = document.getElementById('epSidebarName'); if(sbName) sbName.textContent = user.name || (user.email ? user.email.split('@')[0] : 'User');
      const sbAvatar = document.getElementById('epSidebarAvatar'); if(sbAvatar) sbAvatar.src = user.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.email)}`;

     
      document.getElementById('epUsername').value = user.email ? user.email.split('@')[0] : '';
      document.getElementById('epName').value = user.name || '';
      document.getElementById('epEmail').value = user.email ? user.email.replace(/(.{2}).+(@.+)/, '$1****$2') : '';
      document.getElementById('epPhone').value = user.phone || '';
      if(user.gender){ if(user.gender==='Male') document.getElementById('epGenderMale').checked=true; if(user.gender==='Female') document.getElementById('epGenderFemale').checked=true; if(user.gender==='Other') document.getElementById('epGenderOther').checked=true; }
      
      const daySel = document.getElementById('epDobDay'); daySel.innerHTML = '<option value="">Day</option>'; for(let d=1;d<=31;d++) daySel.innerHTML += `<option value='${d}'>${d}</option>`;
      const monthSel = document.getElementById('epDobMonth'); monthSel.innerHTML = '<option value="">Month</option>'; ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'].forEach((m,i)=> monthSel.innerHTML += `<option value='${i+1}'>${m}</option>`);
      const yearSel = document.getElementById('epDobYear'); yearSel.innerHTML = '<option value="">Year</option>'; const thisY = new Date().getFullYear(); for(let y=thisY;y>=1920;y--) yearSel.innerHTML += `<option value='${y}'>${y}</option>`;
      if(user.dob){ if(user.dob.day) document.getElementById('epDobDay').value = user.dob.day; if(user.dob.month) document.getElementById('epDobMonth').value = user.dob.month; if(user.dob.year) document.getElementById('epDobYear').value = user.dob.year; }

      document.getElementById('epAvatar').src = user.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.email)}`;

      const avInput = document.getElementById('epAvatarInput'); const avBtn = document.getElementById('epSelectImage'); if(avBtn){ avBtn.onclick = () => avInput.click(); }
      if(avInput){ avInput.onchange = function(e){ const f = e.target.files[0]; if(f && f.size < 1024*1024){ const r = new FileReader(); r.onload = (ev)=>{ document.getElementById('epAvatar').src = ev.target.result; }; r.readAsDataURL(f); } else alert('File too large (max 1MB)'); }; }

      const saveBtn = document.getElementById('epSaveBtn'); if(saveBtn) saveBtn.onclick = function(e){ e.preventDefault(); const u = currentUser(); if(!u) return; u.name = document.getElementById('epName').value; u.phone = document.getElementById('epPhone').value; const g = document.querySelector('input[name="epGender"]:checked'); u.gender = g ? g.value : ''; u.dob = { day: document.getElementById('epDobDay').value, month: document.getElementById('epDobMonth').value, year: document.getElementById('epDobYear').value }; u.avatar = document.getElementById('epAvatar').src; localStorage.setItem('ms_user', JSON.stringify(u)); alert('Profile saved (local demo)'); show('account'); renderAccount(); };
      const cancelBtn = document.getElementById('epCancelBtn'); if(cancelBtn) cancelBtn.onclick = function(){ show('account'); renderAccount(); };
    }
}

function renderCatalog(q = '') {
  const container = document.getElementById('catalogList'); container.innerHTML = '';
  const { category, maxPrice, sort, minRating } = getCatalogFilterValues();
  let products = getProducts().filter(p => {
    let match = true;
    if (q && !p.name.toLowerCase().includes(q) && !p.category.toLowerCase().includes(q)) match = false;
    if (category !== 'all' && p.category !== category) match = false;
    if (!isNaN(maxPrice) && maxPrice > 0 && p.price > maxPrice) match = false;
    if (!isNaN(minRating) && minRating > 0 && (p.rating || 0) < minRating) match = false;
    return match;
  });

  if (sort === 'price-asc') products.sort((a, b) => a.price - b.price);
  else if (sort === 'price-desc') products.sort((a, b) => b.price - a.price);
  else if (sort === 'best-rated') products.sort((a, b) => (b.rating||0) - (a.rating||0));
  else if (sort === 'popular') products.sort((a, b) => ((b.reviews||[]).length) - ((a.reviews||[]).length));
  else if (sort === 'newest') products.sort((a, b) => b.id.localeCompare(a.id));

  if (products.length === 0) {
    const no = document.createElement('div'); no.className = 'card'; no.innerHTML = `<div class="preview-empty">No items match your filters. Try adjusting price, category or rating.</div>`; container.appendChild(no); return;
  }

  products.forEach(p => {
    const el = document.createElement('div'); el.className = 'card product-card';
    el.innerHTML = `
      <div class="img-frame"><img src="${p.img}" alt="${p.name}"/></div>
      <div class="card-body">
        <span class="cat-tag">${p.category}</span>
        <strong class="pname">${p.name}</strong>
        <div class="price">‚Ç±${p.price.toFixed(2)}</div>
        <div class="sold-count">${formatSoldCount(getSoldCount(p.id))}</div>
      </div>
      <div class="card-overlay">
        <button class="overlay-btn" data-add="${p.id}">Add to Cart</button>
      </div>
    `;
    el.style.cursor = 'pointer';
    el.addEventListener('click', ()=> openProduct(p.id));
    el.querySelectorAll('[data-add]').forEach(b=> b.addEventListener('click', (e)=>{ addToCart(b.getAttribute('data-add')); e.stopPropagation(); }));
   
    el.addEventListener('dblclick', ()=>{ toggleWish(p.id); });
    container.appendChild(el);
  });
}

  
    function renderCategories(){
          const el = document.getElementById('categoriesRow'); if(!el) return; el.innerHTML='';
          const products = getProducts();
          FIXED_CATEGORIES.forEach(cat=>{
            const rep = products.find(p=>p.category===cat);
              const imgSrc = rep ? rep.img : 'https://placehold.co/120x120?text=No+Image';
            const c = document.createElement('div'); c.className='cat';
            c.innerHTML = `<img src='${imgSrc}' alt='${cat}'/><div class='small' style='margin-top:.4rem;text-align:center'>${cat}</div>`;
            c.onclick = ()=>{
              const catSel = document.getElementById('catalogCategoryFilter');
              if(catSel) catSel.value = cat;
              try {
                history.pushState({page:'catalog', category:cat}, '', '?category=' + encodeURIComponent(cat));
                console.debug('pushState -> catalog', cat);
              } catch(e) {
                console.warn('pushState failed for category', cat, e);
              }
              show('catalog');
              renderCatalog();
            };
            el.appendChild(c);
          });
    }

    function renderFlashDeals(){
      const el = document.getElementById('flashDealsRow'); if(!el) return; el.innerHTML='';
      const products = getProducts().slice(0,10);
      products.forEach(p=>{
        const d = document.createElement('div'); d.className='deal card';
        d.innerHTML = `
            <img src='${p.img}' style='width:100%;height:120px;object-fit:cover;border-radius:8px;margin-bottom:.6rem' />
            <div style='font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis'>${p.name}</div>
            <div class='small' style='color:var(--muted)'>${p.category}</div>
            <div style='margin-top:.4rem;display:flex;justify-content:space-between;align-items:center'><div class='price'>‚Ç±${p.price.toFixed(2)}</div><button class='ghost' data-id='${p.id}'>Buy</button></div>
          `;
        d.querySelectorAll('[data-id]').forEach(b=>b.addEventListener('click',()=>{ addToCart(b.dataset.id); }));
        el.appendChild(d);
      });
    }

    function initCategorySlider(){
      const slider = document.getElementById('homeCatSlider'); if(!slider) return;
      const slidesWrap = document.getElementById('homeCatSlides'); if(!slidesWrap) return;
      const dotsWrap = document.getElementById('catDots');
      const categories = FIXED_CATEGORIES.slice();
      slidesWrap.innerHTML = categories.map(cat => {
        const rep = getProducts().find(p => p.category === cat);
        const img = rep ? rep.img : `https://placehold.co/420x160?text=${encodeURIComponent(cat)}`;
        const banner = CATEGORY_BANNER_TEXT[cat] || {};
        const title = banner.title || cat.split(',')[0];
        const subtitle = banner.subtitle || (rep ? rep.name : 'Shop top picks');
        return `<div class="slide" data-cat="${cat}"><div class="left"><h2 style="margin:0 0 .2rem 0">${escapeHtml(title)}</h2><div class="small">${escapeHtml(subtitle)}</div></div><div class="right" style="background-image:url('${img.replace(/'/g, "\'")}')"></div></div>`;
      }).join('');

      let slides = Array.from(slidesWrap.children || []);
      if(slides.length === 0) return;
      let idx = 0;
      function renderDots(){ if(!dotsWrap) return; dotsWrap.innerHTML = ''; slides.forEach((s,i)=>{ const d = document.createElement('div'); d.className = 'dot' + (i===idx? ' active' : ''); d.addEventListener('click', ()=> goTo(i)); dotsWrap.appendChild(d); }); }
      function update(){ slides = Array.from(slidesWrap.children || []); slidesWrap.style.transform = `translateX(-${idx * 100}%)`; renderDots(); }
      function goTo(i){ idx = (i + slides.length) % slides.length; update(); }
      function next(){ goTo(idx + 1); }
      function prev(){ goTo(idx - 1); }
      const btnNext = document.getElementById('catNext'); const btnPrev = document.getElementById('catPrev'); if(btnNext) btnNext.onclick = next; if(btnPrev) btnPrev.onclick = prev;
      
      let timer = setInterval(next, 4000);
      slider.addEventListener('mouseenter', ()=> clearInterval(timer));
      slider.addEventListener('mouseleave', ()=> timer = setInterval(next, 4000));
      window.addEventListener('resize', update);
      update();
    }

function setupCatalogFilters() {
  const select = document.getElementById('catalogCategoryFilter');
  if(select) select.innerHTML = '<option value="all">All categories</option>' + FIXED_CATEGORIES.map(cat => `<option value="${cat}">${cat}</option>`).join('');

  const products = getProducts();
  const maxProdPrice = products.length ? Math.ceil(Math.max(...products.map(p=>p.price))) : 2000;
  const homePrice = document.getElementById('priceRange');
  const homePriceLabel = document.getElementById('priceLabel');
  const catPrice = document.getElementById('catalogMaxPrice') || document.getElementById('catalogPriceRange');
  const catPriceLabel = document.getElementById('catalogPriceLabel');
  if(homePrice){ homePrice.max = maxProdPrice; homePrice.value = Math.min(homePrice.value || maxProdPrice, maxProdPrice); homePriceLabel.textContent = '‚Ç±' + homePrice.value; }
  if(catPrice){ catPrice.max = maxProdPrice; catPrice.value = Math.min(catPrice.value || maxProdPrice, maxProdPrice); catPriceLabel.textContent = '‚Ç±' + catPrice.value; }

  document.getElementById('catalogCategoryFilter').value = 'all';
  document.getElementById('catalogSortSelect').value = 'newest';

  const qInput = () => document.getElementById('searchInput') ? document.getElementById('searchInput').value.toLowerCase() : '';
  document.getElementById('catalogCategoryFilter').addEventListener('change', () => { renderCatalog(qInput()); });
  if(catPrice) catPrice.addEventListener('input', (e) => { catPriceLabel.textContent = '‚Ç±' + e.target.value; renderCatalog(qInput()); });
  if(document.getElementById('catalogSortSelect')) document.getElementById('catalogSortSelect').addEventListener('change', () => { renderCatalog(qInput()); });
 
  const homeRating = document.getElementById('ratingFilter');
  const catRating = document.getElementById('catalogRatingFilter');
  if(homeRating) homeRating.addEventListener('change', () => { renderCatalog(document.getElementById('searchInput').value.toLowerCase()); });
  if(catRating) catRating.addEventListener('change', () => { renderCatalog(qInput()); });
}


  window.addEventListener('DOMContentLoaded', () => {
  setupCatalogFilters();
  renderCategories();
  renderFlashDeals();
  try{ initCategorySlider(); }catch(e){ console.warn('initCategorySlider failed', e); }
  document.querySelectorAll('.preview-panel').forEach(p=> p.addEventListener('click', (e)=> e.stopPropagation()));
  try {
    const _btnHome = document.getElementById('btnHome'); if(_btnHome){ _btnHome.onclick = () => show('home'); }
    const _btnCatalog = document.getElementById('btnCatalog'); if(_btnCatalog){ _btnCatalog.onclick = () => show('catalog'); }
    const _btnWishlist = document.getElementById('btnWishlist'); if(_btnWishlist){ _btnWishlist.onclick = () => show('wishlist'); }
    const _btnCart = document.getElementById('btnCart'); 
    const _searchBtn = document.getElementById('searchBtn');
    const _searchInput = document.getElementById('searchInput');
    if(_searchBtn && _searchInput){ _searchBtn.onclick = () => { const q = _searchInput.value.trim().toLowerCase(); show('catalog'); renderCatalog(q); }; _searchInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); _searchBtn.click(); } }); }

    const sellerLink = document.getElementById('followFB'); if(sellerLink) sellerLink.onclick = (e)=>{ e.preventDefault(); window.open('https://facebook.com','_blank'); };
    const igLink = document.getElementById('followIG'); if(igLink) igLink.onclick = (e)=>{ e.preventDefault(); window.open('https://instagram.com','_blank'); };
    const helpBtn = document.getElementById('helpBtn'); if(helpBtn) helpBtn.onclick = ()=>{ show('help'); };
    const langSel = document.getElementById('langSelect'); if(langSel) langSel.onchange = ()=>{ alert('Language switched to: '+langSel.value); };
  
    const notifMiniBtn = document.getElementById('notifMini');
    const notifBadge = document.getElementById('notifCount');
    let mockNotifCount = parseInt(localStorage.getItem('ms_notif_count') || '3', 10);
    function updateNotifBadge(){ if(!notifBadge) return; if(mockNotifCount && mockNotifCount>0){ notifBadge.style.display = 'inline-block'; notifBadge.textContent = mockNotifCount>99 ? '99+' : mockNotifCount; } else { notifBadge.style.display = 'none'; } }
    updateNotifBadge();
    if(notifMiniBtn){ notifMiniBtn.addEventListener('click', (e)=>{ e.preventDefault(); if(mockNotifCount>0){ // show demo notifications
        const msgs = [];
        for(let i=1;i<=mockNotifCount;i++) msgs.push('Notification #'+i+' (demo)');
        alert('Notifications:\n\n'+msgs.join('\n'));
        mockNotifCount = 0; localStorage.setItem('ms_notif_count','0'); updateNotifBadge();
      } else { alert('No new notifications'); } }); }
    const catalogBack = document.getElementById('catalogBackBtn'); if(catalogBack){ catalogBack.onclick = () => { try{ const cs = document.getElementById('catalogCategoryFilter'); if(cs) cs.value='all'; const url = new URL(window.location.href); url.searchParams.delete('category'); history.replaceState({}, '', url.pathname + url.search); }catch(e){}; show('home'); }; }
    // initial hide if home is visible
    const btnHomeEl = document.getElementById('btnHome'); if(btnHomeEl){ if(sections.home && sections.home.style.display !== 'none') btnHomeEl.classList.add('hidden'); else btnHomeEl.classList.remove('hidden'); }
  } catch(e) { console.warn('nav attach failed', e); }
});
// close previews when clicking outside
document.addEventListener('click', ()=>{ document.querySelectorAll('.preview-panel.open').forEach(p=>p.classList.remove('open')); });
    document.getElementById('closeProductModal').addEventListener('click',()=>document.getElementById('productModalSection').classList.remove('open'));

    // ------------------------
    // Cart management
    // ------------------------
    function getCart(){
      const u = currentUser();
      if(!u) return []; // no guest carts: require login
      const key = cartKey(u.uid);
      return JSON.parse(localStorage.getItem(key) || '[]');
    }
    function saveCart(arr){
      const u = currentUser();
      if(!u){ openAuthModal(true); console.warn('saveCart blocked: user not signed in'); return; }
      const key = cartKey(u.uid);
      localStorage.setItem(key, JSON.stringify(arr));
    }

    function addToCart(productId, qty=1){
      const u = currentUser(); if(!u){ openAuthModal(true); return; }
      const products = getProducts(); const p = products.find(x=>x.id===productId); if(!p){ alert('Product not found'); return; }
      const cart = getCart(); const existing = cart.find(c=>c.id===productId);
      if(existing){ existing.qty += qty; } else { cart.push({id:productId,qty:qty}); }
      saveCart(cart); refreshUI(); alert('Added to cart');
    }

    function renderCart(){
      const list = document.getElementById('cartList'); if(!list) return; list.innerHTML='';
      const cart = getCart() || []; const products = getProducts(); let subtotal = 0;
      if(cart.length === 0){
        list.innerHTML = `<div class="preview-empty">Your cart is empty. Browse products and add items.</div>`;
        document.getElementById('cartTotal').textContent = '0.00';
        return;
      }
      cart.forEach(item=>{
        const p = products.find(x=>x.id===item.id);
        if(!p) return;
        const row = document.createElement('div'); row.className = 'card cart-item';
        row.innerHTML = `
          <img src="${p.img}" alt="${escapeHtml(p.name)}" />
          <div class="meta">
            <strong style="display:block;">${escapeHtml(p.name)}</strong>
            <div class="small">${p.category} ‚Ä¢ ‚Ç±${p.price.toFixed(2)}</div>
            <div style="margin-top:.6rem;display:flex;gap:.6rem;align-items:center">
              <div class="cart-controls">
                <button class="qty-btn" data-op="dec" data-id="${p.id}">‚àí</button>
                <input class="qty-input" data-id="${p.id}" value="${item.qty}" />
                <button class="qty-btn" data-op="inc" data-id="${p.id}">+</button>
              </div>
              <button class="ghost removeBtn" data-id="${p.id}">Delete</button>
            </div>
          </div>
          <div class="actions">
            <div class="small">‚Ç±${(p.price*item.qty).toFixed(2)}</div>
            </div>
        `;
        list.appendChild(row);
        subtotal += p.price * item.qty;
      });
      document.getElementById('cartTotal').textContent = subtotal.toFixed(2);

      list.querySelectorAll('.qty-btn').forEach(b => {
        b.addEventListener('click', (e) => {
          const id = b.dataset.id; const op = b.dataset.op;
          const cartArr = getCart(); const it = cartArr.find(x=>x.id===id); if(!it) return;
          if(op==='inc') it.qty = Math.min((it.qty||0)+1, 999);
          else if(op==='dec') it.qty = Math.max((it.qty||1)-1, 1);
          saveCart(cartArr); renderCart(); refreshUI();
        });
      });

      list.querySelectorAll('.qty-input').forEach(inp => {
        inp.addEventListener('change', ()=>{
          const id = inp.dataset.id; let v = parseInt(inp.value,10)||1; if(v<1) v=1; const cartArr = getCart(); const it = cartArr.find(x=>x.id===id); if(!it) return; it.qty = v; saveCart(cartArr); renderCart(); refreshUI();
        });
      });

      list.querySelectorAll('.removeBtn').forEach(b=>b.addEventListener('click', ()=>{ removeFromCart(b.dataset.id); }));
    }
    function removeFromCart(id){ const cart = getCart().filter(c=>c.id!==id); saveCart(cart); renderCart(); refreshUI(); }

    document.getElementById('checkoutBtn').addEventListener('click',()=>{ show('checkout'); renderCheckout(); });

    function renderCheckout(){
      const cart = getCart() || []; const products = getProducts(); const summary = document.getElementById('checkoutSummary'); if(!summary) return; summary.innerHTML='';
      if(cart.length === 0){ summary.innerHTML = `<div class="preview-empty">Your cart is empty.</div>`; return; }
    
      let subtotal = 0;
      const itemsHtml = cart.map(item=>{
        const p = products.find(x=>x.id===item.id); if(!p) return '';
        const lineTotal = p.price * item.qty; subtotal += lineTotal;
        return `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.6rem;"><div style="display:flex;gap:.6rem;align-items:center"><img src='${p.img}' style='width:56px;height:56px;object-fit:cover;border-radius:8px' /><div style='min-width:0'><strong style='display:block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:160px'>${escapeHtml(p.name)}</strong><div class='small'>${p.category} ‚Ä¢ Qty: ${item.qty}</div></div></div><div class='price'>‚Ç±${lineTotal.toFixed(2)}</div></div>`;
      }).join('');

      const shippingRates = { standard: 125, express: 350 };
      let shipSel = document.getElementById('checkoutShippingOption');
      if(!shipSel){
        const leftCol = document.querySelector('#checkoutSection .col');
        if(leftCol){
          const div = document.createElement('div'); div.style.marginTop = '.6rem'; div.innerHTML = `<label>Shipping option</label><select id='checkoutShippingOption' style='width:100%;padding:.5rem;margin:.3rem 0;border-radius:6px;border:1px solid #e2e8f0'><option value='standard'>Get by 2-4 days ‚Äî ‚Ç±125</option><option value='express'>Express ‚Äî ‚Ç±350</option></select>`;
          leftCol.insertBefore(div, leftCol.querySelector('#paymentMethod'));
          shipSel = document.getElementById('checkoutShippingOption');
        }
      }

      const selectedShip = shipSel ? shipSel.value : 'standard';
      summary.innerHTML = `
        <div style="font-weight:700;margin-bottom:.6rem">Products Ordered</div>
        <div>${itemsHtml}</div>
        <hr />
        <div class="checkout-summary">
          <div class="line"><div>Subtotal</div><div>‚Ç±<span id="coSubtotal">${subtotal.toFixed(2)}</span></div></div>
          <div class="line checkout-shipping"><div>Shipping</div><div>‚Ç±<span id="coShipping">${shippingRates[selectedShip].toFixed(2)}</span></div></div>
          <div class="line"><strong>Total Payment</strong><strong>‚Ç±<span id="coTotal">${(subtotal + shippingRates[selectedShip]).toFixed(2)}</span></strong></div>
        </div>
      `;

      const user = currentUser(); if(user){ const sn = document.getElementById('shipName'); const sa = document.getElementById('shipAddress'); if(sn && !sn.value) sn.value = user.name || (user.email ? user.email.split('@')[0] : ''); if(sa && !sa.value) sa.value = user.address || '' }

      if(shipSel){ shipSel.onchange = ()=>{ const ss = shipSel.value; const rates = { standard:125, express:350 }; const st = parseFloat(document.getElementById('coSubtotal').textContent||'0'); document.getElementById('coShipping').textContent = rates[ss].toFixed(2); document.getElementById('coTotal').textContent = (st + rates[ss]).toFixed(2); } }

      const paySel = document.getElementById('paymentMethod'); if(paySel){ paySel.onchange = ()=>{ const cb = document.getElementById('cardBox'); if(cb) cb.style.display = paySel.value === 'card' ? '' : 'none'; } }
    }

    document.getElementById('placeOrderBtn').addEventListener('click',()=>{
      const user = currentUser(); if(!user){ if(!confirm('You are not logged in. Place order as guest?')) return; }
      const cart = getCart(); if(!cart || cart.length===0){ alert('Cart empty'); return; }
      const orders = getOrders();
      // Determine shipping selection (checkout takes precedence)
      const shipSel = document.getElementById('checkoutShippingOption') || document.getElementById('shippingOption');
      const shippingKey = shipSel ? shipSel.value : 'standard';
      const shippingRates = { standard:125, express:350 };
      const shippingCost = shippingRates[shippingKey] || 0;
      const shipName = (document.getElementById('shipName') && document.getElementById('shipName').value) || 'Guest';
      const shipAddress = (document.getElementById('shipAddress') && document.getElementById('shipAddress').value) || '-';
      const payment = document.getElementById('paymentMethod') ? document.getElementById('paymentMethod').value : 'cod';
      // compute subtotal from current cart
      const products = getProducts(); let subtotal = 0; cart.forEach(i=>{ const p = products.find(x=>x.id===i.id); if(p) subtotal += (p.price * i.qty); });
      const total = subtotal + shippingCost;
      const newOrder = { id: 'o'+Date.now(), user: user?user.uid:'guest', email: user?user.email:'guest', items: cart, shipping: shippingKey, shipName, shipAddress, payment, status:'Processing', total: total, createdAt: new Date().toISOString() };
      orders.push(newOrder); saveOrders(orders);
      // clear cart
      saveCart([]);
      alert('Order placed (mock). Order ID: '+newOrder.id);
      show('account'); renderAccount();
    });

    // ------------------------
    // Wishlist
    // ------------------------
    function getWishlist(){ const u = currentUser(); const key = wishlistKey(u?u.uid:'guest'); return JSON.parse(localStorage.getItem(key) || '[]'); }
    function saveWishlist(arr){ const u = currentUser(); const key = wishlistKey(u?u.uid:'guest'); localStorage.setItem(key, JSON.stringify(arr)); }
    function toggleWish(id){ const wl = getWishlist(); const idx = wl.indexOf(id); if(idx===-1) wl.push(id); else wl.splice(idx,1); saveWishlist(wl); refreshUI(); }

    // ------------------------
    // Account & Order History
    // ------------------------

    function renderAccount() {
      const info = document.getElementById('accountInfo');
      const user = currentUser();
      if (!user) {
        info.innerHTML = '<div>Please login to see account details.</div>';
        return;
      }
      let adminInfo = '';
      if (isAdmin()) adminInfo = '<div class="small" style="color:#0b78e3;font-weight:bold">You are an admin.</div>';
      info.innerHTML = `<div class="small">Logged in as <strong>${user.email}</strong></div>${adminInfo}<button id="logoutBtn">Logout</button>`;
      document.getElementById('logoutBtn').addEventListener('click', async () => { await doLogout(); });

      // Shopee-style order tabs and search
      const orderTabs = document.querySelectorAll('.orderTabBtn');
      let activeStatus = 'all';
      orderTabs.forEach(btn => {
        btn.onclick = function() {
          orderTabs.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          activeStatus = btn.dataset.status;
          renderOrderList();
        };
      });
      document.getElementById('orderSearchInput').oninput = renderOrderList;

      function renderOrderList() {
        const ol = document.getElementById('orderHistory');
        ol.innerHTML = '';
        const searchVal = document.getElementById('orderSearchInput').value.toLowerCase();
        let orders = getOrders().filter(o => o.user === user.uid);
        if (activeStatus !== 'all') orders = orders.filter(o => o.status === activeStatus);
        if (searchVal) {
          orders = orders.filter(o => {
            const products = getProducts();
            const itemNames = o.items.map(i => {
              const prod = products.find(p => p.id === i.id);
              return prod ? prod.name : '';
            }).join(' ');
            return (o.id.toLowerCase().includes(searchVal) || o.email.toLowerCase().includes(searchVal) || itemNames.toLowerCase().includes(searchVal));
          });
        }
        const products = getProducts();
        orders.forEach(o => {
          let cancelBtn = '';
          if (o.status !== 'Shipped' && o.status !== 'Delivered' && o.status !== 'Cancelled') {
            cancelBtn = `<button class='cancelOrderBtn' data-id='${o.id}' style='background:#e00;color:#fff;margin-top:.5rem;'>Cancel Order</button>`;
          }
          let itemsHtml = o.items.map(item => {
            const prod = products.find(x => x.id === item.id);
            if (!prod) return '';
            return `
              <div style='display:flex;align-items:center;margin-bottom:.7rem;'>
                <img src='${prod.img}' style='width:60px;height:60px;object-fit:cover;border-radius:8px;margin-right:1rem;'>
                <div style='flex:1;'>
                  <strong>${prod.name}</strong><br>
                  <span class='small'>Variation: ${prod.category}</span><br>
                  <span class='small'>Qty: ${item.qty}</span>
                </div>
                <div class='price'>‚Ç±${(prod.price * item.qty).toFixed(2)}</div>
              </div>
            `;
          }).join('');
          ol.innerHTML += `
            <div class='card' style='margin-bottom:1.2rem;'>
              <div style='display:flex;justify-content:space-between;align-items:center;'>
                <div><strong>Order ID: ${o.id}</strong></div>
                <div style='color:var(--accent);font-weight:bold;'>${o.status}</div>
              </div>
              <div class='small'>Date: ${new Date(o.createdAt).toLocaleString()}</div>
              <div class='small'>Shipping: ${o.shipping}</div>
              <div class='small'>Name: ${o.shipName}</div>
              <div class='small'>Address: ${o.shipAddress}</div>
              <div class='small'>Payment: ${o.payment}</div>
              <div class='small'>Email: ${o.email}</div>
              <hr />
              ${itemsHtml}
              <hr />
              <div style='display:flex;justify-content:space-between;align-items:center;'>
                <div class='small'><b>Order Total: ‚Ç±${o.total ? o.total.toFixed(2) : '0.00'}</b></div>
                <div style='display:flex;gap:.7rem;'>
                  ${cancelBtn}
                  <button class='buyAgainBtn' data-id='${o.id}' style='background:var(--accent);color:#fff;'>Buy Again</button>
                  <button class='viewCancelBtn' data-id='${o.id}' style='background:#eee;color:#222;'>View Cancellation Details</button>
                  <button class='contactSellerBtn' data-id='${o.id}' style='background:#ffe3db;color:var(--accent);'>Contact Seller</button>
                </div>
              </div>
            </div>
          `;
        });
        // Attach cancel event
        ol.querySelectorAll('.cancelOrderBtn').forEach(btn => {
          btn.onclick = function() {
            if (!confirm('Cancel this order?')) return;
            const orders = getOrders();
            const ord = orders.find(x => x.id === btn.dataset.id);
            if (ord && ord.status !== 'Shipped' && ord.status !== 'Delivered' && ord.status !== 'Cancelled') {
              ord.status = 'Cancelled';
              saveOrders(orders);
              renderOrderList();
              alert('Order cancelled.');
            }
          };
        });
        // Buy Again, View Cancellation, Contact Seller (mock)
        ol.querySelectorAll('.buyAgainBtn').forEach(btn => {
          btn.onclick = function() { alert('Buy Again (mock)'); };
        });
        ol.querySelectorAll('.viewCancelBtn').forEach(btn => {
          btn.onclick = function() { alert('View Cancellation Details (mock)'); };
        });
        ol.querySelectorAll('.contactSellerBtn').forEach(btn => {
          btn.onclick = function() { alert('Contact Seller (mock)'); };
        });
      }
      // Initial render
      renderOrderList();
    }

    // ------------------------
    // Admin features (simple guard)
    // Admin is identified if currentUser().email equals adminEmail, or you can flag in localStorage
    // ------------------------
    const adminEmail = 'beyyaah_21@gmail.com'; // change to your admin email
    function isAdmin(){ const u = currentUser(); return u && u.email===adminEmail; }

    function renderAdmin(){
      // Attach logout event for admin page button
      const adminLogoutBtn = document.getElementById('adminPageLogoutBtn');
      if (adminLogoutBtn) {
        adminLogoutBtn.onclick = async () => { await doLogout(); };
      }
      if(!isAdmin()){
        document.getElementById('adminSection').innerHTML = '<div class="container"><div class="card"><h3>Admin</h3><p>You are not authorized to view this page.</p></div></div>';
        return;
      }
      // Tab logic
      function showAdminTab(tab) {
        document.getElementById('adminTabProducts').style.display = tab === 'products' ? 'block' : 'none';
        document.getElementById('adminTabAddProduct').style.display = tab === 'add' ? 'block' : 'none';
        document.getElementById('adminTabOrders').style.display = tab === 'orders' ? 'block' : 'none';
        document.getElementById('adminTabAnalytics').style.display = tab === 'analytics' ? 'block' : 'none';
      }
      // Attach tab events with active-state handling
      const tabBtnIds = ['tabAdminProducts','tabAdminAddProduct','tabAdminOrders','tabAdminAnalytics'];
      function activateAdminTab(btnId, tabName){
        tabBtnIds.forEach(id => { const el = document.getElementById(id); if(el) el.classList.remove('active'); });
        const btn = document.getElementById(btnId); if(btn) btn.classList.add('active');
        showAdminTab(tabName);
      }
      document.getElementById('tabAdminProducts').onclick = () => activateAdminTab('tabAdminProducts','products');
      document.getElementById('tabAdminAddProduct').onclick = () => activateAdminTab('tabAdminAddProduct','add');
      document.getElementById('tabAdminOrders').onclick = () => activateAdminTab('tabAdminOrders','orders');
      document.getElementById('tabAdminAnalytics').onclick = () => activateAdminTab('tabAdminAnalytics','analytics');
      // Default tab
      activateAdminTab('tabAdminProducts','products');

      // Products list (styled as user product cards)
      const adminProducts = document.getElementById('adminProducts'); adminProducts.innerHTML='';
      getProducts().forEach(p=>{
        const card = document.createElement('div');
        card.className = 'card product-card';
        card.innerHTML = `
          <div class="img-frame"><img src="${p.img}" alt="${p.name}"/></div>
          <div>
            <div style="display:flex;justify-content:space-between">
              <div>
                <strong>${p.name}</strong>
                <div class="small">${p.category} ‚Ä¢ ${p.stock} in stock</div>
              </div>
              <div class="price">‚Ç±${p.price.toFixed(2)}</div>
            </div>
            <div style="display:flex;gap:.4rem;margin-top:.6rem">
              <button data-id="${p.id}" class="editP">Edit</button>
              <button data-id="${p.id}" class="delP" style="background:#e00;color:#fff">Delete</button>
            </div>
          </div>
        `;
        adminProducts.appendChild(card);
      });
      adminProducts.querySelectorAll('.editP').forEach(b=>b.addEventListener('click',()=>{
        const id=b.dataset.id;
        const p = getProducts().find(x=>x.id===id);
        if(!p) return;
        showAdminTab('add');
        document.getElementById('pId').value=p.id;
        document.getElementById('pName').value=p.name;
        document.getElementById('pCategory').value=p.category;
        document.getElementById('pPrice').value=p.price;
        document.getElementById('pStock').value=p.stock;
        document.getElementById('pImage').value=p.img;
        document.getElementById('pDesc').value=p.desc;
      }));
      adminProducts.querySelectorAll('.delP').forEach(b=>b.addEventListener('click',()=>{
        if(confirm('Delete product?')){
          const prods = getProducts().filter(x=>x.id!==b.dataset.id);
          saveProducts(prods);
          renderAdmin();
          renderCatalog();
          renderFeatured();
        }
      }));

      // Orders tab
      // Orders tab
      const adminOrders = document.getElementById('adminOrders'); adminOrders.innerHTML = '';
      // Wire up toolbar events (search / sort / refresh)
      const searchInput = document.getElementById('adminOrderSearch');
      const sortSelect = document.getElementById('adminOrderSort');
      const refreshBtn = document.getElementById('adminRefreshOrders');
      if (searchInput) searchInput.oninput = () => { renderAdmin(); };
      if (sortSelect) sortSelect.onchange = () => { renderAdmin(); };
      if (refreshBtn) refreshBtn.onclick = () => { renderAdmin(); };

      const q = (searchInput && searchInput.value) ? searchInput.value.toLowerCase() : '';
      const sortBy = (sortSelect && sortSelect.value) ? sortSelect.value : 'newest';

      let ordersList = getOrders().slice();
      if (q) {
        ordersList = ordersList.filter(o => {
          const products = getProducts();
          const itemNames = (o.items || []).map(i => { const prod = products.find(p => p.id === i.id); return prod ? prod.name : ''; }).join(' ').toLowerCase();
          return (o.id && o.id.toLowerCase().includes(q)) || (o.email && o.email.toLowerCase().includes(q)) || itemNames.includes(q);
        });
      }
      // sorting
      if (sortBy === 'newest') ordersList.sort((a,b)=> (b.createdAt||'').localeCompare(a.createdAt||''));
      else if (sortBy === 'oldest') ordersList.sort((a,b)=> (a.createdAt||'').localeCompare(b.createdAt||''));
      else if (sortBy === 'total-desc') ordersList.sort((a,b)=> (b.total||0)-(a.total||0));
      else if (sortBy === 'total-asc') ordersList.sort((a,b)=> (a.total||0)-(b.total||0));

        function statusIconHtml(s){
          const ss = (s||'').toLowerCase();
          if(ss.includes('process')) return `<span class="status-icon">‚è≥</span>`;
          if(ss.includes('shipped')) return `<span class="status-icon">üöö</span>`;
          if(ss.includes('deliver')) return `<span class="status-icon">‚úÖ</span>`;
          if(ss.includes('cancel')) return `<span class="status-icon">‚ùå</span>`;
          return `<span class="status-icon">‚è≥</span>`;
        }

        ordersList.forEach(o => {
        const d = document.createElement('div');
        d.className = 'order-card card';
        function statusClass(s){ if(!s) return 'status-processing'; const ss = s.toLowerCase(); if(ss.includes('process')) return 'status-processing'; if(ss.includes('shipped')) return 'status-shipped'; if(ss.includes('deliver')) return 'status-delivered'; if(ss.includes('cancel')) return 'status-cancelled'; return 'status-processing'; }
        const statusCls = statusClass(o.status);
        const dateStr = o.createdAt ? new Date(o.createdAt).toLocaleString() : '';
        const products = getProducts();
        const itemsHtml = (o.items || []).map(item => { const p = products.find(x=>x.id===item.id); return `
          <div style="display:flex;align-items:center;margin-bottom:.6rem;">
            <img src="${p?p.img:''}" style="width:50px;height:50px;object-fit:cover;border-radius:8px;margin-right:.6rem;">
            <div style="flex:1;min-width:0"><strong>${p?p.name:item.id}</strong><div class="small">${p?p.category:''} ‚Ä¢ Qty: ${item.qty}</div></div>
            <div class="price">‚Ç±${p?(p.price*item.qty).toFixed(2):'0.00'}</div>
          </div>`; }).join('');

        const iconHtml = statusIconHtml(o.status);
        d.innerHTML = `
          <div class="order-meta">
            <div style="display:flex;justify-content:space-between;align-items:center;gap:1rem;">
              <div><strong>Order ${o.id}</strong><div class="muted">${o.email || ''}</div></div>
              <div class="muted">${dateStr}</div>
            </div>
            <div style="margin-top:.6rem">${itemsHtml}</div>
            <div style="margin-top:.4rem" class="muted">Shipping: ${o.shipping || '-'} ‚Ä¢ Payment: ${o.payment || '-'} ‚Ä¢ Address: ${o.shipAddress || '-'}</div>
          </div>
          <div class="order-actions">
            <div class="status-badge ${statusCls}">${iconHtml}${o.status || 'Processing'}</div>
            <select data-id='${o.id}' class='statusSel' aria-label='Status select'>
              <option>Processing</option><option>Shipped</option><option>Delivered</option><option>Cancelled</option>
            </select>
            <div style="display:flex;gap:.5rem;">
              <button data-id='${o.id}' class='updBtn'>Update</button>
              <button data-id='${o.id}' class='viewOrderBtn ghost'>View</button>
            </div>
            <div class="small" style="margin-top:.2rem;"><strong>‚Ç±${o.total ? (o.total).toFixed(2) : '0.00'}</strong></div>
          </div>
        `;
        adminOrders.appendChild(d);
        d.querySelector('.statusSel').value = o.status;
        d.querySelector('.updBtn').addEventListener('click', ()=>{
          const orders = getOrders(); const ord = orders.find(x=>x.id===o.id); if(!ord) return; ord.status = d.querySelector('.statusSel').value; saveOrders(orders); renderAdmin();
        });
        d.querySelectorAll('.viewOrderBtn').forEach(b=> b.addEventListener('click', ()=>{ alert('Order details:\n'+JSON.stringify(o,null,2)); }));
      });

      // Analytics tab
      const report = document.getElementById('salesReport');
      const orders = getOrders();
      const totalSales = orders.reduce((s,o)=>s+(o.total||0),0);
      report.innerHTML = `<div class='small'>Orders: ${orders.length} ‚Ä¢ Total Sales: ‚Ç±${totalSales.toFixed(2)}</div>`;

      // Coupons (now in analytics tab)
      const couponList = document.getElementById('couponList');
      couponList.innerHTML='';
      getCoupons().forEach(c=>{
        const el = document.createElement('div');
        el.className='small';
        el.textContent = `${c.code} ‚Ä¢ ${c.percent}%`;
        couponList.appendChild(el);
      });
      // Support Messages admin view (analytics)
      const helpAdminWrap = document.getElementById('helpMessagesAdmin');
      if(helpAdminWrap){
        helpAdminWrap.innerHTML = '';
        const msgs = JSON.parse(localStorage.getItem('ms_help_messages_v1') || '[]');
        if(!msgs || msgs.length === 0){ helpAdminWrap.innerHTML = '<div class="small">No support messages.</div>'; }
        else {
          msgs.slice().reverse().forEach(m => {
            const card = document.createElement('div'); card.className = 'card'; card.style.marginBottom = '.6rem';
            card.innerHTML = `
              <div style="display:flex;justify-content:space-between;gap:1rem;align-items:flex-start">
                <div style="min-width:0">
                  <strong>${escapeHtml(m.name || 'Anonymous')}</strong>
                  <div class="small">${escapeHtml(m.email || '')} ‚Ä¢ ${new Date(m.createdAt).toLocaleString()}</div>
                  <div style="margin-top:.6rem">${escapeHtml(m.message || '')}</div>
                </div>
                <div style="text-align:right">
                  <button class="delHelp" data-id="${m.id}" style="background:#e00;color:#fff">Delete</button>
                </div>
              </div>
            `;
            helpAdminWrap.appendChild(card);
          });
          // attach delete handlers
          helpAdminWrap.querySelectorAll('.delHelp').forEach(b=> b.addEventListener('click', ()=>{
            if(!confirm('Delete this support message?')) return;
            const arr = JSON.parse(localStorage.getItem('ms_help_messages_v1') || '[]').filter(x=> x.id !== b.dataset.id);
            localStorage.setItem('ms_help_messages_v1', JSON.stringify(arr));
            renderAdmin();
          }));
        }
      }
    }

    document.getElementById('saveProductBtn').addEventListener('click',()=>{
      if(!isAdmin()){ alert('Not authorized'); return; }
      const id = document.getElementById('pId').value || 'p'+Date.now();
      const name = document.getElementById('pName').value; const cat = document.getElementById('pCategory').value; const price = parseFloat(document.getElementById('pPrice').value)||0; const stock = parseInt(document.getElementById('pStock').value)||0; const img = document.getElementById('pImage').value; const desc = document.getElementById('pDesc').value;
      const prods = getProducts(); const idx = prods.findIndex(x=>x.id===id);
      const payload = {id,name,category:cat,price,stock,img,desc,rating:4,reviews:[]};
  if(idx===-1) prods.push(payload); else prods[idx]=payload; saveProducts(prods); populateCategoryFilter(); renderCatalog(); renderAdmin(); renderFeatured(); alert('Saved');
    });

    document.getElementById('addCouponBtn').addEventListener('click',()=>{
      if(!isAdmin()){ alert('Not authorized'); return; }
      const code = document.getElementById('couponCode').value.trim(); const pct = parseInt(document.getElementById('couponDisc').value)||0;
      if(!code) return alert('Enter code'); const coupons = getCoupons(); coupons.push({code,percent:pct}); saveCoupons(coupons); renderAdmin();
    });

    // ------------------------
    // Utilities & UI refresh
    // --- Ratings & Reviews helpers ---
    function renderStars(rating) {
      rating = Math.round(rating * 2) / 2;
      let stars = '';
      for(let i=1;i<=5;i++) {
        if(rating >= i) stars += '‚òÖ';
        else if(rating >= i-0.5) stars += '‚òÜ';
        else stars += '‚òÜ';
      }
      return `<span style='color:#f5b50a;font-size:1.1em'>${stars}</span>`;
    }
    function renderReviews(reviews) {
      if(!reviews || reviews.length===0) return '<div class="small">No reviews yet.</div>';
      return reviews.map(r=>`<div style='margin-bottom:.5rem'><strong>${r.name}</strong> <span class='small'>${renderStars(r.rating)} ${new Date(r.date).toLocaleDateString()}</span><br/><span>${r.text}</span></div>`).join('');
    }
    function calcAvgRating(reviews) {
      if(!reviews || reviews.length===0) return 4.5;
      let sum = reviews.reduce((a,b)=>a+b.rating,0);
      return Math.round((sum/reviews.length)*10)/10;
    }
    // ------------------------
    function refreshUI(){
      // Only render listing UI when user is signed in
      if(currentUser()){
        renderFeatured(); renderCatalog();
      }
      // counts
      cartCountEl.textContent = getCart().length;
      // Only count wishlist items that exist in products
      const wl = getWishlist();
      const products = getProducts();
      const validWishCount = wl.filter(id => products.some(p => p.id === id)).length;
      if (wishCountEl) wishCountEl.textContent = validWishCount;
      // account (guard in case accountBox is not present)
      const u = currentUser();
      if (typeof accountBox !== 'undefined' && accountBox && accountBox !== null) {
        if (u) accountBox.innerHTML = `<div class="small">${u.email}</div><div class="small">UID: ${u.uid}</div>`;
        else accountBox.innerHTML = 'Not logged in';
      }
      // Hide the right-side account panel if we already show account controls in the header
      const heroRight = document.querySelector('.hero-right');
      try { if(heroRight) heroRight.style.display = u ? 'none' : ''; } catch(e) { /* ignore */ }
      // header previews and user label
      renderWishPreview(); renderUserPreview();
      // Ensure Home button hidden when Home section is visible
      try {
        const _btnHome = document.getElementById('btnHome');
        if (_btnHome) {
          if (sections.home && sections.home.style.display !== 'none') {
            _btnHome.classList.add('hidden');
            _btnHome.setAttribute('aria-hidden', 'true');
          } else {
            _btnHome.classList.remove('hidden');
            _btnHome.setAttribute('aria-hidden', 'false');
          }
        }
      } catch(e) { /* ignore */ }
      // render account and admin if visible
      if(sections.account.style.display!=='none') renderAccount();
      if(sections.admin.style.display!=='none') renderAdmin();
      // wishlist view
      renderWishlist();
      // cart view
      if(sections.cart.style.display!=='none') renderCart();
      // debug panel removed in production
    }

    function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    // cart preview removed (dropdown not used) to reduce unused code

    function renderWishPreview(){
      const panel = document.getElementById('wishPreview'); if(!panel) return; panel.innerHTML='';
      const wl = getWishlist(); const products = getProducts(); if(wl.length===0){ panel.innerHTML='<div class="preview-empty">Wishlist is empty</div>'; return; }
      wl.slice(0,5).forEach(id=>{ const p = products.find(x=>x.id===id); if(!p) return; const row = document.createElement('div'); row.className='preview-item'; row.innerHTML = `<img src='${p.img}'/><div style="flex:1"><strong style="font-size:.95rem">${p.name}</strong><div class='small'>‚Ç±${p.price.toFixed(2)}</div></div><div><button class='ghost' data-id='${p.id}'>Add</button></div>`; panel.appendChild(row); });
      const more = document.createElement('div'); more.style.textAlign='right'; more.innerHTML = `<div style="margin-top:.4rem"><button class='ghost' onclick="show('wishlist')">View Wishlist</button></div>`; panel.appendChild(more);
    }

    function renderUserPreview(){
      const panel = document.getElementById('userPreview'); if(!panel) return; panel.innerHTML='';
      const u = currentUser(); if(!u){ panel.innerHTML = `<div style="padding:.6rem"><button class='ghost' onclick="openAuthModal(true)">Login / Register</button></div>`; return; }
     
      panel.innerHTML = `
        <div style="padding:.8rem;display:flex;flex-direction:column;align-items:center;gap:.6rem;min-width:260px">
          <img id="pvAvatar" src="https://ui-avatars.com/api/?name=${encodeURIComponent(u.email)}" style="width:72px;height:72px;border-radius:50%;box-shadow:0 2px 8px #eee;" />
          <div id="pvName" style="font-weight:700">${u.email}</div>
          <div style="width:100%;display:flex;flex-direction:column;gap:.45rem;margin-top:.4rem">
            <button id="pvEdit" class="ghost">Edit Profile</button>
            <button id="pvOrdersBtn" class="ghost">My Orders</button>
            <button id="pvLogout" style="background:#e00;color:#fff">Logout</button>
          </div>
        </div>
      `;

      const btnEdit = document.getElementById('pvEdit'); if(btnEdit) btnEdit.onclick = function(e){ e.stopPropagation(); document.querySelectorAll('.preview-panel.open').forEach(p=>p.classList.remove('open')); show('editProfile'); try{ renderEditProfile(); }catch(err){ console.warn('renderEditProfile missing',err); } };
      const btnOrders = document.getElementById('pvOrdersBtn'); if(btnOrders) btnOrders.onclick = () => show('account');
      const btnLogout = document.getElementById('pvLogout'); if(btnLogout) btnLogout.onclick = async () => { await doLogout(); };
    
      const avatar = document.getElementById('hdrAvatar'); if(avatar) avatar.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(u.email)}`;
      const lbl = document.getElementById('hdrEmailLabel'); if(lbl) lbl.textContent = u.email.split('@')[0];
    }

    function renderWishlist(){
      const list = document.getElementById('wishlistList');
      list.innerHTML = '';
      const wl = getWishlist();
      const products = getProducts();
      wl.forEach(id => {
        const p = products.find(x => x.id === id);
        if(!p) return;
        const el = document.createElement('div'); el.className = 'card product-card';
        el.innerHTML = `<div class="img-frame"><img src="${p.img}"/></div><div><strong>${p.name}</strong><div class='small'>‚Ç±${p.price}</div><div style='margin-top:.6rem'><button class='addBtn' data-id='${p.id}'>Add to Cart</button></div></div>`;
        list.appendChild(el);
      });
      list.querySelectorAll('.addBtn').forEach(b=>b.addEventListener('click',()=>addToCart(b.dataset.id)));
    }

    // initial show
    // Only show login/register modal until authenticated
    function enforceAuthUI() {
      const user = currentUser();
      console.log('enforceAuthUI: currentUser ->', user);
      if (!user) {
        Object.values(sections).forEach(s => { if (s) s.style.display = 'none'; });
        openAuthModal(true);
        const hdr = document.querySelector('header'); if (hdr) hdr.style.display = 'none';
        const ftr = document.querySelector('footer'); if (ftr) ftr.style.display = 'none';
      } else {
        const hdr = document.querySelector('header'); if (hdr) hdr.style.display = '';
        const ftr = document.querySelector('footer'); if (ftr) ftr.style.display = '';
        if (isAdmin()) {
          show('admin');
          try { renderAdmin(); } catch(e) { console.error('renderAdmin failed', e); }
          const searchEl = document.querySelector('.search'); if (searchEl) searchEl.style.display = 'none';
          const navActions = document.querySelector('.nav-actions'); if (navActions) navActions.style.display = 'none';
          const userSidebarEl = document.getElementById('userSidebar'); if (userSidebarEl) userSidebarEl.style.display = 'none';
        } else {
          show('home');
          refreshUI();
          const searchEl = document.querySelector('.search'); if (searchEl) searchEl.style.display = '';
          const navActions = document.querySelector('.nav-actions'); if (navActions) navActions.style.display = '';
          // wire up header navigation buttons if present
          const _btnHome = document.getElementById('btnHome'); if(_btnHome) _btnHome.onclick = () => show('home');
          const _btnCatalog = document.getElementById('btnCatalog'); if(_btnCatalog) _btnCatalog.onclick = () => show('catalog');
          const _btnWishlist = document.getElementById('btnWishlist'); if(_btnWishlist) _btnWishlist.onclick = () => show('wishlist');
          const _btnCart = document.getElementById('btnCart'); // cart preview uses its own click handler
          // Show user sidebar and update info
          // Update user info and attach events to buttons inside hero-right card
          const userProfileName = document.getElementById('userProfileName');
          const userAvatar = document.getElementById('userAvatar');
          const sidebarWishCount = document.getElementById('sidebarWishCount');
          const sidebarCartCount = document.getElementById('sidebarCartCount');
          const sidebarWishlistBtn = document.getElementById('sidebarWishlistBtn');
          const sidebarCartBtn = document.getElementById('sidebarCartBtn');
          const sidebarLogoutBtn = document.getElementById('sidebarLogoutBtn');
          const editUserProfileBtn = document.getElementById('editUserProfileBtn');

          if (userProfileName) userProfileName.textContent = user ? user.email : 'User';
          if (userAvatar) userAvatar.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(user ? user.email : 'User')}`;
          if (sidebarWishCount) {
            const wl = getWishlist();
            const products = getProducts();
            const validWishCount = wl.filter(id => products.some(p => p.id === id)).length;
            sidebarWishCount.textContent = validWishCount;
          }
          if (sidebarCartCount) sidebarCartCount.textContent = getCart().length;
          if (sidebarWishlistBtn) sidebarWishlistBtn.onclick = () => show('wishlist');
          if (sidebarCartBtn) sidebarCartBtn.onclick = () => show('cart');
            const sidebarOrdersBtn = document.getElementById('sidebarOrdersBtn');
            if (sidebarOrdersBtn) sidebarOrdersBtn.onclick = () => {
              show('account');
              // Switch to My Orders tab if present
              const tabMyOrders = document.getElementById('tabMyOrders');
              if (tabMyOrders) tabMyOrders.click();
            };
          if (sidebarLogoutBtn) sidebarLogoutBtn.onclick = async () => { if(window.doLogout && typeof window.doLogout === 'function') await window.doLogout(); else await doLogout(); };
          if (editUserProfileBtn) editUserProfileBtn.onclick = () => openEditUserProfileModal();
        }
    // Modal for editing user profile
    function openEditUserProfileModal() {
      let modal = document.getElementById('editUserProfileModal');
      if (!modal) {
        modal = document.createElement('section');
        modal.id = 'editUserProfileModal';
        modal.className = 'modal';
        modal.innerHTML = `
          <div class="panel card" style="max-width:700px;text-align:left;padding:2.2rem 2.2rem;">
            <h2 style="margin-bottom:.2rem;font-size:2rem;font-weight:600;">My Profile</h2>
            <div style="color:#888;margin-bottom:1.2rem;font-size:1.08rem;">Manage and protect your account</div>
            <hr style="border:none;border-top:1px solid #eee;margin-bottom:2.2rem;" />
            <form id="editProfileForm" style="display:grid;grid-template-columns:2fr 1fr;gap:2.5rem;align-items:flex-start;">
              <div>
                <label style="font-weight:500;">Username</label><br>
                <input id="editUsername" type="text" style="width:100%;margin-bottom:.5rem;padding:.9rem 1rem;font-size:1.1rem;border-radius:8px;border:1px solid #e2e8f0;" disabled />
                <div class="small" style="color:#888;margin-bottom:1.2rem;">Username can only be changed once.</div>
                <label style="font-weight:500;">Name</label><br>
                <input id="editName" type="text" style="width:100%;margin-bottom:1.2rem;padding:.9rem 1rem;font-size:1.1rem;border-radius:8px;border:1px solid #e2e8f0;" />
                <label style="font-weight:500;">Email</label><br>
                <input id="editEmail" type="text" style="width:100%;margin-bottom:.2rem;padding:.9rem 1rem;font-size:1.1rem;border-radius:8px;border:1px solid #e2e8f0;" disabled />
                <a href="#" style="color:#1976d2;font-size:.98rem;text-decoration:underline;margin-bottom:1.2rem;display:inline-block;">Change</a>
                <label style="font-weight:500;">Phone Number</label><br>
                <input id="editPhone" type="text" style="width:100%;margin-bottom:.2rem;padding:.9rem 1rem;font-size:1.1rem;border-radius:8px;border:1px solid #e2e8f0;" disabled />
                <a href="#" style="color:#1976d2;font-size:.98rem;text-decoration:underline;margin-bottom:1.2rem;display:inline-block;">Change</a>
                <label style="font-weight:500;">Gender <span title="Why do we ask?" style="color:#888;cursor:help;font-size:1.1em;">&#9432;</span></label><br>
                <input type="radio" name="editGender" value="Male" id="genderMale"><label for="genderMale" style="margin-right:1.2rem;"> Male</label>
                <input type="radio" name="editGender" value="Female" id="genderFemale"><label for="genderFemale" style="margin-right:1.2rem;"> Female</label>
                <input type="radio" name="editGender" value="Other" id="genderOther"><label for="genderOther"> Other</label><br><br>
                <label style="font-weight:500;">Date of birth <span title="Why do we ask?" style="color:#888;cursor:help;font-size:1.1em;">&#9432;</span></label><br>
                <select id="dobDay" style="width:90px;padding:.6rem .7rem;border-radius:8px;border:1px solid #e2e8f0;margin-right:.7rem;"></select>
                <select id="dobMonth" style="width:120px;padding:.6rem .7rem;border-radius:8px;border:1px solid #e2e8f0;margin-right:.7rem;"></select>
                <select id="dobYear" style="width:120px;padding:.6rem .7rem;border-radius:8px;border:1px solid #e2e8f0;"></select>
                <br><br>
                <button id="saveUserProfileBtn" style="background:#f44336;color:#fff;padding:.9rem 2.2rem;margin-top:1.2rem;font-size:1.1rem;border-radius:8px;border:none;">Save</button>
                <button id="closeEditUserProfileModal" class="ghost" style="margin-left:1rem;padding:.9rem 2.2rem;font-size:1.1rem;border-radius:8px;">Cancel</button>
              </div>
              <div style="display:flex;flex-direction:column;align-items:center;">
                <img id="editProfileAvatar" src="https://ui-avatars.com/api/?name=User" style="width:130px;height:130px;border-radius:50%;margin-bottom:1.2rem;background:#f3f6fa;object-fit:cover;border:1px solid #eee;" />
                <button id="selectImageBtn" type="button" style="background:#fff;border:1px solid #e2e8f0;color:#222;padding:.7rem 1.5rem;border-radius:8px;font-size:1.05rem;margin-bottom:.7rem;cursor:pointer;">Select Image</button>
                <input type="file" id="editAvatarInput" accept="image/*" style="display:none;" />
                <span class="small" style="color:#888;margin-top:.7rem;">File size: maximum 1 MB<br>File extension: .JPEG, .PNG</span>
              </div>
            </form>
          </div>
        `;
        document.body.appendChild(modal);
        // Populate day/month/year dropdowns
        const daySel = modal.querySelector('#dobDay');
        for (let d = 1; d <= 31; d++) daySel.innerHTML += `<option value='${d}'>${d}</option>`;
        const monthSel = modal.querySelector('#dobMonth');
        ['Month','Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'].forEach((m,i) => { if(i) monthSel.innerHTML += `<option value='${i}'>${m}</option>`; else monthSel.innerHTML += `<option value=''>${m}</option>`; });
        const yearSel = modal.querySelector('#dobYear');
        const thisYear = new Date().getFullYear();
        yearSel.innerHTML += `<option value=''>Year</option>`;
        for (let y = thisYear; y >= 1920; y--) yearSel.innerHTML += `<option value='${y}'>${y}</option>`;
      }
      // Fill user data
      const user = currentUser();
      modal.classList.add('open');
      modal.querySelector('#editUsername').value = user ? (user.email.split('@')[0]) : '';
      modal.querySelector('#editName').value = user ? (user.name || user.email.split('@')[0]) : '';
      // Masked email
      modal.querySelector('#editEmail').value = user ? (user.email.replace(/(.{2}).+(@.+)/, '$1****$2')) : '';
      // Masked phone
      modal.querySelector('#editPhone').value = user && user.phone ? (user.phone.replace(/.(?=.{2})/g, '*')) : '*********85';
      // Gender
      if (user && user.gender) {
        modal.querySelectorAll('input[name="editGender"]').forEach(r => { r.checked = (r.value === user.gender); });
      }
      // DOB
      if (user && user.dob) {
        modal.querySelector('#dobDay').value = user.dob.day || '';
        modal.querySelector('#dobMonth').value = user.dob.month || '';
        modal.querySelector('#dobYear').value = user.dob.year || '';
      }
      // Avatar
      modal.querySelector('#editProfileAvatar').src = user && user.avatar ? user.avatar : `https://ui-avatars.com/api/?name=${encodeURIComponent(user ? user.email : 'User')}`;
      // Avatar upload
      const avatarInput = modal.querySelector('#editAvatarInput');
      const selectImageBtn = modal.querySelector('#selectImageBtn');
      selectImageBtn.onclick = function() {
        avatarInput.click();
      };
      avatarInput.onchange = function(e) {
        const file = e.target.files[0];
        if (file && file.size < 1024*1024) {
          const reader = new FileReader();
          reader.onload = function(ev) {
            modal.querySelector('#editProfileAvatar').src = ev.target.result;
          };
          reader.readAsDataURL(file);
        } else {
          alert('File too large (max 1MB)');
        }
      };
      // Save/cancel
      modal.querySelector('#closeEditUserProfileModal').onclick = () => { modal.classList.remove('open'); };
      modal.querySelector('#saveUserProfileBtn').onclick = function(e) {
        e.preventDefault();
        // Save to localStorage (mock)
        if (user) {
          user.name = modal.querySelector('#editName').value;
          user.gender = modal.querySelector('input[name="editGender"]:checked') ? modal.querySelector('input[name="editGender"]:checked').value : '';
          user.dob = {
            day: modal.querySelector('#dobDay').value,
            month: modal.querySelector('#dobMonth').value,
            year: modal.querySelector('#dobYear').value
          };
          user.avatar = modal.querySelector('#editProfileAvatar').src;
          localStorage.setItem('ms_user', JSON.stringify(user));
          document.getElementById('userProfileName').textContent = user.name;
          document.getElementById('userAvatar').src = user.avatar;
        }
        modal.classList.remove('open');
      };
    }
      }
    }

    // Call enforceAuthUI on page load and on auth state change
    enforceAuthUI();
  window.addEventListener('DOMContentLoaded', () => {
  // Populate filters and render catalog even if user is not yet recognized by ms_user
  populateCategoryFilter();
  const cf = document.getElementById('categoryFilter'); if(cf) cf.value = 'all';
  const pr = document.getElementById('priceRange'); if(pr) pr.value = 1000;
  const pl = document.getElementById('priceLabel'); if(pl) pl.textContent = '‚Ç±1000';
  // initialize catalog max price numeric input if present
  const cpr = document.getElementById('catalogMaxPrice') || document.getElementById('catalogPriceRange');
  const cpl = document.getElementById('catalogPriceLabel');
  if(cpr) cpr.value = 1000;
  if(cpl) cpl.textContent = '‚Ç±1000';
  renderCatalog();
});

// Help form handlers
document.addEventListener('click', (e) => {
  if (e.target && e.target.id === 'sendHelpBtn') {
    const name = document.getElementById('helpName').value.trim();
    const email = document.getElementById('helpEmail').value.trim();
    const msg = document.getElementById('helpMessage').value.trim();
    const fb = document.getElementById('helpFeedback');
    if (!name || !email || !msg) { if(fb) fb.textContent = 'Please fill all fields.'; return; }
    // For demo, persist the help message to localStorage and show confirmation
    const helpLogKey = 'ms_help_messages_v1';
    const store = JSON.parse(localStorage.getItem(helpLogKey) || '[]');
    store.push({ id: 'h'+Date.now(), name, email, message: msg, createdAt: new Date().toISOString() });
    localStorage.setItem(helpLogKey, JSON.stringify(store));
    if(fb) fb.textContent = 'Message sent. We will get back to you üòä.';
    document.getElementById('helpForm').reset();
  }
  if (e.target && e.target.id === 'helpBackBtn') { show('home'); }
});

// Help: FAQs and suggested questions data + UI
const HELP_FAQS = [
  { q: 'How do I place an order?', a: 'Add items to your cart then proceed to Checkout where you can select shipping and payment.' },
  { q: 'What payment methods are accepted?', a: 'We accept demo Credit/Debit Card, E‚ÄëWallet and Cash on Delivery.' },
  { q: 'How do I track my order?', a: 'Visit your Account ‚Üí My Orders to see order status and tracking updates.' },
  { q: 'How do I cancel an order?', a: 'You can cancel orders that are not yet shipped from the My Orders page if the status allows it.' },
  { q: 'Can I return or exchange an item?', a: 'Use the Order page to request returns.' }
];

const HELP_SUGGESTED = [
  'Where is my tracking number?',
  'How do I apply a coupon?',
  'Change shipping address',
  'Payment failed ‚Äî what now?',
  'Request a refund'
];

function renderHelpSuggested(){
  const wrap = document.getElementById('helpSuggestedList'); if(!wrap) return; wrap.innerHTML = '';
  HELP_SUGGESTED.forEach(s => {
    const btn = document.createElement('button'); btn.className = 'ghost'; btn.style.textAlign = 'left'; btn.style.padding = '.6rem'; btn.textContent = s;
    btn.onclick = () => { const inp = document.getElementById('helpSearchInput'); if(inp){ inp.value = s; renderHelpFAQs(s); const msg = document.getElementById('helpMessage'); if(msg) msg.value = s; window.scrollTo({top: document.getElementById('helpSection').offsetTop - 60, behavior: 'smooth'}); }
    };
    wrap.appendChild(btn);
  });
  // Also fill the small chips under hero
  const heroWrap = document.getElementById('helpSuggested'); if(heroWrap){ heroWrap.innerHTML = HELP_SUGGESTED.map(s=>`<button class="ghost" style="padding:.45rem .8rem;border-radius:999px">${s}</button>`).join(' ');
    heroWrap.querySelectorAll('button').forEach((b,i)=>{ b.addEventListener('click', ()=>{ const txt = HELP_SUGGESTED[i]; const inp = document.getElementById('helpSearchInput'); if(inp) inp.value = txt; renderHelpFAQs(txt); const msg = document.getElementById('helpMessage'); if(msg) msg.value = txt; }); });
  }
}

function renderHelpFAQs(q=''){
  const container = document.getElementById('helpFaqs'); if(!container) return; container.innerHTML = '';
  const query = (q||'').toLowerCase();
  const items = HELP_FAQS.filter(f=> !query || f.q.toLowerCase().includes(query) || f.a.toLowerCase().includes(query));
  if(items.length===0){ container.innerHTML = '<div class="small">No matching FAQs. Try a different search or contact support.</div>'; return; }
  items.forEach((f,idx)=>{
    const div = document.createElement('div'); div.style.marginBottom = '.6rem';
    div.innerHTML = `<button class='ghost' style='width:100%;text-align:left;padding:.6rem;font-weight:700' data-idx='${idx}'>${f.q}</button><div class='small' style='padding:.6rem;border-left:3px solid #ffe6e0;margin-top:.3rem;display:none' data-ans='${idx}'>${f.a}</div>`;
    container.appendChild(div);
  });
  // toggle answers
  container.querySelectorAll('button[data-idx]').forEach(b=> b.addEventListener('click', (ev)=>{
    const idx = b.getAttribute('data-idx'); const ans = container.querySelector(`div[data-ans='${idx}']`);
    if(!ans) return; ans.style.display = ans.style.display === 'none' ? 'block' : 'none';
  }));
}

// wire search box
document.addEventListener('input', (e)=>{ if(e.target && e.target.id === 'helpSearchInput'){ renderHelpFAQs(e.target.value); } });
document.addEventListener('click', (e)=>{ if(e.target && e.target.id === 'helpSearchBtn'){ const v = document.getElementById('helpSearchInput').value; renderHelpFAQs(v); } });

// initial render when the file loads
renderHelpSuggested(); renderHelpFAQs();

    // Token-based auth initialization (JWT stored in localStorage.ms_token)
    (async function initAuth(){
      try{
        if(localStorage.getItem('ms_token')){
          await fetchMe();
        }
      } catch(e){ console.warn('initAuth failed', e); }
      try{ enforceAuthUI(); refreshUI(); } catch(e){}
    })();

    // QuickBuy demo (guard element exists)
    const quickBuyBtn = document.getElementById('quickBuyBtn');
    if(quickBuyBtn) quickBuyBtn.addEventListener('click',()=>{
      const p = getProducts()[0]; if(p) { addToCart(p.id); show('checkout'); renderCheckout(); }
    });

    // Catalog back button: navigate browser history (fallback to Home)
    const catalogBackBtn = document.getElementById('catalogBackBtn');
    if(catalogBackBtn) catalogBackBtn.addEventListener('click', ()=>{
      console.debug('catalogBackBtn clicked');
      try {
        const catSel = document.getElementById('catalogCategoryFilter'); if(catSel) catSel.value = 'all';
        // clear category query param from URL without creating history entry
        try { const url = new URL(window.location.href); url.searchParams.delete('category'); history.replaceState({}, '', url.pathname + url.search); } catch(err) { /* ignore */ }
      } catch(e) { console.warn(e); }
      show('home');
    });

    // Handle popstate so Back/Forward renders app state correctly
    window.addEventListener('popstate', (e) => {
      console.debug('popstate event:', e && e.state);
      const st = e.state;
      if (st && st.page === 'catalog') {
        const catSel = document.getElementById('catalogCategoryFilter'); if(catSel) catSel.value = st.category || 'all';
        show('catalog'); renderCatalog();
      } else {
        // fallback: read category from URL if state is missing
        try {
          const params = new URLSearchParams(window.location.search);
          const cat = params.get('category');
          if (cat) {
            const catSel = document.getElementById('catalogCategoryFilter'); if(catSel) catSel.value = cat;
            show('catalog'); renderCatalog();
            return;
          }
        } catch(err) { /* ignore */ }
        show('home');
      }
    });

    // simple price range filter (guard elements)
    const priceRangeEl = document.getElementById('priceRange');
    if(priceRangeEl) priceRangeEl.addEventListener('input',(e)=>{
      const lbl = document.getElementById('priceLabel'); if(lbl) lbl.textContent = '‚Ç±'+e.target.value;
      const si = document.getElementById('searchInput'); renderCatalog(si ? si.value.toLowerCase() : '');
    });
    const catFilterEl = document.getElementById('categoryFilter');
    if(catFilterEl) catFilterEl.addEventListener('change',()=>{
      const si = document.getElementById('searchInput'); renderCatalog(si ? si.value.toLowerCase() : '');
    });

  </script>
</body>
</html>
      